<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worcester CRE Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet for AI Analysis Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- html2pdf for Report Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- html2canvas for Map Capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --hot: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* Top Navigation */
        .top-nav {
            background: var(--gray-900);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            color: white;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dashboard Stats Bar */
        .stats-bar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 24px;
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-value.highlight {
            color: var(--primary);
        }

        .stat-value.hot {
            color: var(--hot);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .lead-panel {
                display: none;
            }
            .lead-panel.mobile-visible {
                display: block;
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh;
                z-index: 200;
                box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            }
        }

        /* Property List Section */
        .property-section {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--gray-50);
        }

        .search-bar {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input-container {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gray-300);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--gray-600);
        }

        .search-clear:hover {
            background: var(--gray-400);
            color: white;
        }

        .search-input:not(:placeholder-shown) + .search-clear,
        .search-clear.visible {
            display: flex;
        }

        /* Search Suggestions Dropdown */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 50;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .search-suggestions.visible {
            display: block;
        }

        .search-suggestion-group {
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .search-suggestion-group:last-child {
            border-bottom: none;
        }

        .search-suggestion-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--gray-500);
            padding: 4px 16px;
            letter-spacing: 0.5px;
        }

        .search-suggestion-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
        }

        .search-suggestion-item:hover {
            background: var(--gray-50);
        }

        .search-suggestion-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .search-suggestion-text {
            flex: 1;
        }

        .search-suggestion-main {
            font-size: 14px;
            color: var(--gray-900);
        }

        .search-suggestion-sub {
            font-size: 12px;
            color: var(--gray-500);
        }

        .search-highlight {
            background: #fef08a;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Advanced Search Button */
        .advanced-search-btn {
            padding: 10px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            color: var(--gray-600);
        }

        .advanced-search-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Search Results Info */
        .search-results-info {
            font-size: 13px;
            color: var(--gray-500);
            padding: 8px 16px;
            background: var(--gray-50);
            border-radius: 6px;
            display: none;
        }

        .search-results-info.visible {
            display: block;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .quick-filter {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .quick-filter:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .quick-filter.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Advanced Search Modal */
        .advanced-search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 400;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .advanced-search-modal.active {
            display: flex;
        }

        .advanced-search-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .advanced-search-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .advanced-search-title {
            font-size: 18px;
            font-weight: 700;
        }

        .advanced-search-body {
            padding: 24px;
        }

        .advanced-search-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .advanced-search-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .advanced-search-field.full-width {
            grid-column: span 2;
        }

        .advanced-search-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
        }

        .advanced-search-input {
            padding: 10px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
        }

        .advanced-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .advanced-search-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Recent Searches */
        .recent-searches {
            padding: 8px 0;
        }

        .recent-search-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .recent-search-item:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .recent-search-delete {
            margin-left: auto;
            opacity: 0;
            color: var(--gray-400);
        }

        .recent-search-item:hover .recent-search-delete {
            opacity: 1;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-chip .count {
            background: var(--gray-200);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .filter-chip.active .count {
            background: rgba(255,255,255,0.3);
        }

        /* Property List */
        .property-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            gap: 16px;
        }

        .property-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .property-card.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.02);
        }

        .property-card.has-lead {
            border-left: 4px solid var(--success);
        }

        .property-card.has-lead.hot {
            border-left-color: var(--hot);
        }

        .property-main {
            flex: 1;
        }

        .property-address {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .property-owner {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .property-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--gray-500);
            flex-wrap: wrap;
        }

        .property-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .property-value {
            text-align: right;
            min-width: 100px;
        }

        .property-value .amount {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .property-value .label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .lead-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .lead-badge.new { background: var(--gray-200); color: var(--gray-700); }
        .lead-badge.contacted { background: #dbeafe; color: #1e40af; }
        .lead-badge.interested { background: #d1fae5; color: #065f46; }
        .lead-badge.hot { background: #fee2e2; color: #991b1b; }
        .lead-badge.follow_up { background: #fef3c7; color: #92400e; }
        .lead-badge.not_interested { background: var(--gray-200); color: var(--gray-600); }
        .lead-badge.closed { background: var(--gray-300); color: var(--gray-600); }

        /* Lead Panel */
        .lead-panel {
            background: white;
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .lead-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lead-panel-title {
            font-size: 18px;
            font-weight: 700;
        }

        .lead-panel-close {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
        }

        @media (max-width: 1200px) {
            .lead-panel-close { display: block; }
        }

        .lead-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .lead-panel-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }

        .lead-panel-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Lead Form */
        .lead-form-section {
            margin-bottom: 24px;
        }

        .lead-form-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 8px;
            display: block;
        }

        .status-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .status-btn {
            padding: 10px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }

        .status-btn:hover {
            border-color: var(--gray-400);
        }

        .status-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
            color: var(--primary);
        }

        .status-btn.hot.active {
            border-color: var(--hot);
            background: rgba(220, 38, 38, 0.05);
            color: var(--hot);
        }

        .priority-stars {
            display: flex;
            gap: 4px;
        }

        .priority-star {
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-300);
            transition: all 0.2s;
        }

        .priority-star:hover,
        .priority-star.active {
            color: var(--warning);
        }

        .lead-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .lead-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .lead-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .lead-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .lead-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Property Quick Info in Lead Panel */
        .lead-property-info {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .lead-property-address {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .lead-property-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            font-size: 13px;
        }

        .lead-property-detail {
            display: flex;
            flex-direction: column;
        }

        .lead-property-detail .label {
            color: var(--gray-500);
            font-size: 11px;
            text-transform: uppercase;
        }

        .lead-property-detail .value {
            color: var(--gray-900);
            font-weight: 600;
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: white;
            border-top: 1px solid var(--gray-200);
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--gray-600);
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray-500);
            line-height: 1;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 8px;
        }

        .detail-item .label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .detail-item .value {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Photos Grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .photo-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-item:hover {
            transform: scale(1.02);
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        /* Lightbox / Fullscreen Image Viewer */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }

        .lightbox-overlay.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }

        .lightbox-content img {
            max-width: 90vw;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .lightbox-caption {
            text-align: center;
            color: white;
            padding: 12px;
            font-size: 14px;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 10000;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 4px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 400;
        }

        .toast {
            background: var(--gray-900);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Dirty/unsaved changes indicator */
        .dirty-indicator {
            padding: 8px 12px;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
        }

        /* Validation error states */
        .lead-input.input-error,
        .lead-textarea.input-error {
            border-color: #dc2626;
            background-color: #fef2f2;
        }

        .lead-input.input-error:focus,
        .lead-textarea.input-error:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .field-error {
            color: #dc2626;
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-error::before {
            content: '⚠';
        }

        /* Loading button state */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Last saved display */
        .last-saved-display {
            margin-top: 12px;
            padding: 8px 12px;
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 6px;
            font-size: 12px;
            color: #166534;
            text-align: center;
        }

        /* View Toggle & Export Controls */
        .controls-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle-btn {
            padding: 8px 12px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .view-toggle-btn:not(:last-child) {
            border-right: 1px solid var(--gray-300);
        }

        .view-toggle-btn:hover {
            background: var(--gray-100);
        }

        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        .export-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #059669;
        }

        .export-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .selection-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .selection-controls button {
            padding: 4px 8px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .selection-controls button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .property-type-filter {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            background: white;
        }

        /* Checkbox Styles */
        .property-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .property-card-with-checkbox {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .property-card-checkbox-area {
            padding-top: 4px;
        }

        /* Table View Styles */
        .property-table-container {
            flex: 1;
            overflow: auto;
            background: white;
        }

        .property-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .property-table thead {
            background: var(--gray-800);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .property-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .property-table th:hover {
            background: var(--gray-700);
        }

        .property-table th.sortable::after {
            content: ' ↕';
            opacity: 0.5;
            font-size: 11px;
        }

        .property-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        .property-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        .property-table tbody tr {
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: background 0.15s;
        }

        .property-table tbody tr:hover {
            background: var(--gray-50);
        }

        .property-table tbody tr.selected {
            background: rgba(37, 99, 235, 0.08);
        }

        .property-table tbody tr.row-checked {
            background: rgba(37, 99, 235, 0.05);
        }

        .property-table td {
            padding: 12px 16px;
            vertical-align: middle;
        }

        .property-table .owner-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .property-table .address-cell {
            font-weight: 600;
            color: var(--gray-900);
        }

        .property-table .value-cell {
            font-weight: 600;
            color: var(--primary);
        }

        .property-table .ownership-cell.long-term {
            color: var(--warning);
            font-weight: 600;
        }

        .table-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .table-badge.residential { background: #dbeafe; color: #1e40af; }
        .table-badge.commercial { background: #fef3c7; color: #92400e; }
        .table-badge.mixed { background: #e0e7ff; color: #3730a3; }

        /* Sort dropdown for mobile */
        .sort-dropdown {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            background: white;
        }

        /* Business Certificates Styles */
        .business-cert-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: #dbeafe;
            color: #1e40af;
            gap: 4px;
        }

        .business-cert-badge.expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .business-cert-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #7dd3fc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .business-cert-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #0369a1;
        }

        .business-cert-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .business-cert-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e0e7ff;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .business-cert-item.expired {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .business-cert-info {
            flex: 1;
        }

        .business-cert-name {
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .business-cert-details {
            font-size: 12px;
            color: var(--gray-600);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .business-cert-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .business-cert-status .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .business-cert-status .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .business-cert-status .status-badge.expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .business-cert-status .expiry-date {
            font-size: 11px;
            color: var(--gray-500);
        }

        .has-business-cert {
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        /* AI Analysis Section */
        .ai-analysis-section {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #c084fc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-analysis-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .ai-analysis-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            color: #7c3aed;
        }

        .ai-cached-badge {
            background: #dcfce7;
            color: #166534;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .ai-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-download-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .ai-download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .ai-download-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-download-btn .download-icon {
            width: 14px;
            height: 14px;
        }

        .ai-analyze-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
        }

        .ai-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .ai-analyze-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-analyze-btn .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-analyze-subtitle {
            font-size: 13px;
            color: #9333ea;
            text-align: center;
            margin-top: 10px;
        }

        /* AI Scores Display */
        .ai-scores-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 24px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .ai-scores-container {
                grid-template-columns: 1fr;
            }
        }

        .ai-radar-chart {
            width: 200px;
            height: 200px;
        }

        .ai-scores-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
        }

        .ai-score-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-score-label {
            width: 120px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .ai-score-bar {
            flex: 1;
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
        }

        .ai-score-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-out;
        }

        .ai-score-fill.walkability { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .ai-score-fill.transit { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .ai-score-fill.market-stability { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .ai-score-fill.future-growth { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .ai-score-fill.amenity-density { background: linear-gradient(90deg, #ec4899, #db2777); }

        .ai-score-value {
            width: 36px;
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-800);
            text-align: right;
        }

        /* AI Markdown Analysis */
        .ai-markdown-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 16px;
        }

        .ai-markdown-container h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 20px 0 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--gray-100);
        }

        .ai-markdown-container h2:first-child {
            margin-top: 0;
        }

        .ai-markdown-container p {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-600);
            margin-bottom: 12px;
        }

        .ai-markdown-container ul, .ai-markdown-container ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .ai-markdown-container li {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-600);
            margin-bottom: 6px;
        }

        .ai-markdown-container strong {
            color: var(--gray-800);
        }

        /* PDF/Print page break control */
        .ai-markdown-container h2,
        .ai-markdown-container h3 {
            break-after: avoid;
            page-break-after: avoid;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .ai-markdown-container p,
        .ai-markdown-container li {
            break-inside: avoid;
            page-break-inside: avoid;
            orphans: 3;
            widows: 3;
        }

        .ai-score-card,
        .ai-radar-chart,
        .ai-sources,
        .ai-map-container {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        /* AI Sources */
        .ai-sources {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .ai-sources-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ai-source-link {
            font-size: 12px;
            color: #7c3aed;
            text-decoration: none;
            background: #f5f3ff;
            padding: 4px 10px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .ai-source-link:hover {
            background: #ede9fe;
            color: #6d28d9;
        }

        /* AI Map Section */
        .ai-map-container {
            width: 100%;
            height: 350px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--gray-200);
        }

        .ai-map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .ai-map-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-map-link {
            font-size: 12px;
            color: #7c3aed;
            text-decoration: none;
        }

        .ai-map-link:hover {
            text-decoration: underline;
        }

        .ai-map-legend {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 11px;
        }

        .ai-map-legend-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-map-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            color: var(--gray-600);
        }

        .ai-map-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .ai-map-legend-dot.food { background: #f59e0b; }
        .ai-map-legend-dot.transit { background: #3b82f6; }
        .ai-map-legend-dot.commercial { background: #10b981; }
        .ai-map-legend-dot.shop { background: #ec4899; }
        .ai-map-legend-dot.property { background: #ef4444; }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.1);
            padding: 4px;
            border-radius: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--gray-400);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        .nav-tab .tab-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }

        .nav-tab.active .tab-count {
            background: rgba(255,255,255,0.3);
        }

        /* View Containers */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        /* Business Certificates Styles */
        .cert-stats-bar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 24px;
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }

        .cert-table-container {
            flex: 1;
            overflow: auto;
            background: white;
            margin: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .cert-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .cert-table th {
            background: var(--gray-50);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            position: sticky;
            top: 0;
            cursor: pointer;
            white-space: nowrap;
        }

        .cert-table th:hover {
            background: var(--gray-100);
        }

        .cert-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .cert-table tr:hover {
            background: var(--gray-50);
        }

        .cert-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .cert-status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .cert-status-badge.expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .cert-business-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .cert-address {
            color: var(--gray-600);
            font-size: 12px;
        }

        .cert-search-bar {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .cert-filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .cert-filter-chip {
            padding: 6px 14px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cert-filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .cert-filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .cert-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: white;
            border-top: 1px solid var(--gray-200);
        }

        .cert-pagination button {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cert-pagination button:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .cert-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cert-section {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .linked-property-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 11px;
            cursor: pointer;
        }

        .linked-property-link:hover {
            text-decoration: underline;
        }

        /* Expiration Date Filter */
        .cert-date-filters {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .cert-date-filters label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            white-space: nowrap;
        }

        .cert-date-select {
            padding: 6px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 90px;
        }

        .cert-date-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .cert-quick-filters {
            display: flex;
            gap: 6px;
        }

        .cert-quick-filter {
            padding: 5px 10px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .cert-quick-filter:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .cert-quick-filter.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .cert-clear-date {
            padding: 5px 10px;
            border: none;
            background: var(--gray-200);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            color: var(--gray-600);
        }

        .cert-clear-date:hover {
            background: var(--gray-300);
        }

        .cert-filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo">
            <div class="logo-icon">🏢</div>
            <span>Worcester CRE</span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-view="properties" onclick="switchView('properties')">
                🏠 Properties
                <span class="tab-count" id="tabPropertiesCount">-</span>
            </button>
            <button class="nav-tab" data-view="certificates" onclick="switchView('certificates')">
                🏪 Business Certificates
                <span class="tab-count" id="tabCertsCount">-</span>
            </button>
            <button class="nav-tab" data-view="permits" onclick="switchView('permits')">
                🔨 Building Permits
                <span class="tab-count" id="tabPermitsCount">-</span>
            </button>
        </div>
        <div style="color: var(--gray-400); font-size: 14px;">
            <span id="lastUpdated"></span>
        </div>
    </nav>

    <!-- Properties View -->
    <div id="propertiesView" class="view-container active">
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">Total Properties</span>
            <span class="stat-value" id="statTotalProperties">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Active Leads</span>
            <span class="stat-value highlight" id="statActiveLeads">0</span>
            <!-- <button onclick="resetAllLeads()" style="font-size: 10px; padding: 2px 6px; margin-top: 4px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;" title="Delete all leads">Reset All</button> -->
        </div>
        <div class="stat-item">
            <span class="stat-label">Hot Leads</span>
            <span class="stat-value hot" id="statHotLeads">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Follow-ups Today</span>
            <span class="stat-value" id="statFollowUps">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Avg. Ownership</span>
            <span class="stat-value" id="statAvgOwnership">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Long-Term (20+ yrs)</span>
            <span class="stat-value" id="statLongTerm">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Avg. Assessed Value</span>
            <span class="stat-value" id="statAvgValue">-</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Property List Section -->
        <div class="property-section">
            <div class="search-bar">
                <div class="search-input-container" id="searchContainer">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search address, owner, parcel ID, neighborhood..." autocomplete="off">
                    <button class="search-clear" id="searchClear" onclick="clearSearch()" title="Clear search">✕</button>
                    
                    <!-- Search Suggestions Dropdown -->
                    <div class="search-suggestions" id="searchSuggestions">
                        <div class="recent-searches" id="recentSearches"></div>
                        <div class="search-suggestion-group" id="quickSearches">
                            <div class="search-suggestion-title">Quick Searches</div>
                            <div class="search-suggestion-item" onclick="applyQuickSearch('value', '500000')">
                                <span class="search-suggestion-icon">💰</span>
                                <span class="search-suggestion-text">
                                    <div class="search-suggestion-main">High Value Properties</div>
                                    <div class="search-suggestion-sub">Assessed value over $500K</div>
                                </span>
                            </div>
                            <div class="search-suggestion-item" onclick="applyQuickSearch('ownership', '30')">
                                <span class="search-suggestion-icon">⏳</span>
                                <span class="search-suggestion-text">
                                    <div class="search-suggestion-main">Very Long-Term Owners</div>
                                    <div class="search-suggestion-sub">30+ years ownership</div>
                                </span>
                            </div>
                            <div class="search-suggestion-item" onclick="applyQuickSearch('type', 'commercial')">
                                <span class="search-suggestion-icon">🏢</span>
                                <span class="search-suggestion-text">
                                    <div class="search-suggestion-main">Commercial Properties</div>
                                    <div class="search-suggestion-sub">Office, retail, industrial</div>
                                </span>
                            </div>
                        </div>
                        <div class="search-suggestion-group" id="searchResults"></div>
                    </div>
                </div>
                
                <button class="advanced-search-btn" onclick="openAdvancedSearch()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/>
                        <line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/>
                        <line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/>
                        <line x1="17" y1="16" x2="23" y2="16"/>
                    </svg>
                    Advanced
                </button>
                
                <div class="search-results-info" id="searchResultsInfo"></div>
                
                <div class="filter-chips">
                    <button class="filter-chip" data-filter="all" onclick="setFilter('all')">All</button>
                    <button class="filter-chip" data-filter="leads" onclick="setFilter('leads')">My Leads <span class="count" id="filterLeadsCount">0</span></button>
                    <button class="filter-chip" data-filter="new" onclick="setFilter('new')">New <span class="count" id="filterNewCount">0</span></button>
                    <button class="filter-chip" data-filter="contacted" onclick="setFilter('contacted')">Contacted <span class="count" id="filterContactedCount">0</span></button>
                    <button class="filter-chip" data-filter="interested" onclick="setFilter('interested')">Interested <span class="count" id="filterInterestedCount">0</span></button>
                    <button class="filter-chip" data-filter="hot" onclick="setFilter('hot')">🔥 Hot <span class="count" id="filterHotCount">0</span></button>
                    <button class="filter-chip" data-filter="follow_up" onclick="setFilter('follow_up')">Follow-up <span class="count" id="filterFollowUpCount">0</span></button>
                    <button class="filter-chip" data-filter="not_interested" onclick="setFilter('not_interested')">Not Int. <span class="count" id="filterNotInterestedCount">0</span></button>
                    <button class="filter-chip" data-filter="long_term" onclick="setFilter('long_term')">⏳ 20+ Years <span class="count" id="filterLongTermCount">0</span></button>
                    <button class="filter-chip" data-filter="has_business" onclick="setFilter('has_business')">🏪 Has Business <span class="count" id="filterBusinessCount">0</span></button>
                </div>
            </div>

            <!-- Controls Row -->
            <div class="search-bar" style="border-top: none; padding-top: 8px;">
                <div class="controls-row">
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" data-view="cards" onclick="setViewMode('cards')">📇 Cards</button>
                        <button class="view-toggle-btn" data-view="table" onclick="setViewMode('table')">📊 Table</button>
                    </div>
                    
                    <select class="property-type-filter" id="propertyTypeFilter" onchange="setPropertyTypeFilter(this.value)">
                        <option value="all">All Types</option>
                        <option value="residential">🏠 Residential</option>
                        <option value="commercial">🏢 Commercial</option>
                        <option value="mixed">🏘️ Mixed Use</option>
                        <option value="other">📋 Other</option>
                    </select>

                    <select class="sort-dropdown" id="sortDropdown" onchange="setSortColumn(this.value)">
                        <option value="total_assessed_value">Sort: Value</option>
                        <option value="ownership_years">Sort: Ownership</option>
                        <option value="location">Sort: Address</option>
                        <option value="owner_name">Sort: Owner</option>
                        <option value="year_built">Sort: Year Built</option>
                    </select>

                    <div class="selection-controls">
                        <span><span id="selectedCount">0</span> selected</span>
                        <button onclick="selectAll()">Select All</button>
                        <button onclick="deselectAll()">Deselect All</button>
                    </div>

                    <button class="export-btn" id="exportBtn" onclick="exportSelectedToCSV()" disabled>
                        📥 Export CSV (<span id="exportCount">0</span>)
                    </button>
                </div>
            </div>

            <!-- Card View -->
            <div id="propertyList" class="property-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading properties...</p>
                </div>
            </div>

            <!-- Table View (hidden by default) -->
            <div id="propertyTableContainer" class="property-table-container" style="display: none;">
                <table class="property-table" id="propertyTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" class="property-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                            <th class="sortable" data-sort="location" onclick="handleColumnSort('location')">Address</th>
                            <th class="sortable" data-sort="owner_name" onclick="handleColumnSort('owner_name')">Owner</th>
                            <th class="sortable" data-sort="total_assessed_value" onclick="handleColumnSort('total_assessed_value')">Value</th>
                            <th class="sortable" data-sort="ownership_years" onclick="handleColumnSort('ownership_years')">Ownership</th>
                            <th class="sortable" data-sort="year_built" onclick="handleColumnSort('year_built')">Year Built</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="propertyTableBody">
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button class="pagination-btn" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
                <span class="pagination-info" id="paginationInfo">Page 1</span>
                <button class="pagination-btn" id="nextBtn" onclick="nextPage()">Next</button>
            </div>
        </div>

        <!-- Lead Management Panel -->
        <div class="lead-panel" id="leadPanel">
            <div class="lead-panel-header">
                <span class="lead-panel-title">Lead Management</span>
                <button class="lead-panel-close" onclick="closeLeadPanel()">&times;</button>
            </div>
            <div class="lead-panel-content" id="leadPanelContent">
                <div class="lead-panel-empty">
                    <div class="lead-panel-empty-icon">📋</div>
                    <p>Select a property to manage lead details</p>
                </div>
            </div>
        </div>
    </div>
    </div><!-- End Properties View -->

    <!-- Business Certificates View -->
    <div id="certificatesView" class="view-container">
        <!-- Certificates Stats Bar -->
        <div class="cert-stats-bar">
            <div class="stat-item">
                <span class="stat-label">Total Certificates</span>
                <span class="stat-value" id="certStatTotal">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Active</span>
                <span class="stat-value highlight" id="certStatActive">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Expired</span>
                <span class="stat-value" id="certStatExpired">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Linked to Properties</span>
                <span class="stat-value" id="certStatLinked">-</span>
            </div>
        </div>

        <!-- Certificates Section -->
        <div class="cert-section">
            <!-- Search and Filters -->
            <div class="cert-search-bar">
                <div class="search-input-container" style="flex: 1; min-width: 300px;">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="certSearchInput" class="search-input" placeholder="Search business name, address, certificate #..." autocomplete="off">
                    <button class="search-clear" id="certSearchClear" onclick="clearCertSearch()" style="display: none;">✕</button>
                </div>

                <div class="cert-filter-chips">
                    <button class="cert-filter-chip active" data-filter="all" onclick="setCertFilter('all')">All</button>
                    <button class="cert-filter-chip" data-filter="active" onclick="setCertFilter('active')">✅ Active</button>
                    <button class="cert-filter-chip" data-filter="expired" onclick="setCertFilter('expired')">❌ Expired</button>
                    <button class="cert-filter-chip" data-filter="linked" onclick="setCertFilter('linked')">🔗 Linked</button>
                </div>
            </div>

            <!-- Expiration Date Filter Row -->
            <div class="cert-search-bar" style="padding-top: 8px; border-top: none;">
                <div class="cert-filters-row">
                    <div class="cert-date-filters">
                        <label>📅 Expiration:</label>
                        <select id="certExpYear" class="cert-date-select" onchange="applyDateFilter()">
                            <option value="">Any Year</option>
                        </select>
                        <select id="certExpMonth" class="cert-date-select" onchange="applyDateFilter()">
                            <option value="">Any Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <button class="cert-clear-date" onclick="clearDateFilter()">Clear</button>
                    </div>

                    <div class="cert-quick-filters">
                        <button class="cert-quick-filter" data-quick="30" onclick="setQuickDateFilter(30)">Next 30 days</button>
                        <button class="cert-quick-filter" data-quick="90" onclick="setQuickDateFilter(90)">Next 90 days</button>
                        <button class="cert-quick-filter" data-quick="365" onclick="setQuickDateFilter(365)">Next 12 months</button>
                        <button class="cert-quick-filter" data-quick="thisYear" onclick="setQuickDateFilter('thisYear')">This Year</button>
                        <button class="cert-quick-filter" data-quick="nextYear" onclick="setQuickDateFilter('nextYear')">Next Year</button>
                    </div>
                </div>

                <div class="cert-results-info" id="certResultsInfo" style="color: var(--gray-500); font-size: 13px; margin-left: auto;"></div>
            </div>

            <!-- Certificates Table -->
            <div class="cert-table-container">
                <table class="cert-table">
                    <thead>
                        <tr>
                            <th onclick="sortCerts('certificate_number')">Cert #</th>
                            <th onclick="sortCerts('business_name')">Business Name</th>
                            <th onclick="sortCerts('address')">Address</th>
                            <th onclick="sortCerts('file_date')">File Date</th>
                            <th onclick="sortCerts('expiration_date')">Expiration</th>
                            <th>Status</th>
                            <th>Property</th>
                        </tr>
                    </thead>
                    <tbody id="certTableBody">
                        <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading certificates...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="cert-pagination">
                <button onclick="certPrevPage()" id="certPrevBtn" disabled>← Previous</button>
                <span id="certPageInfo">Page 1</span>
                <button onclick="certNextPage()" id="certNextBtn">Next →</button>
            </div>
        </div>
    </div><!-- End Certificates View -->

    <!-- Building Permits View -->
    <div id="permitsView" class="view-container">
        <!-- Permits Stats Bar -->
        <div class="cert-stats-bar">
            <div class="stat-item">
                <span class="stat-label">Total Permits</span>
                <span class="stat-value" id="permitStatTotal">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Issued</span>
                <span class="stat-value highlight" id="permitStatIssued">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Pending</span>
                <span class="stat-value" id="permitStatPending">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Linked to Properties</span>
                <span class="stat-value" id="permitStatLinked">-</span>
            </div>
        </div>

        <!-- Permits Section -->
        <div class="cert-section">
            <!-- Search and Filters -->
            <div class="cert-search-bar">
                <div class="search-input-container" style="flex: 1; min-width: 300px;">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="permitSearchInput" class="search-input" placeholder="Search record #, address, contractor..." autocomplete="off">
                    <button class="search-clear" id="permitSearchClear" onclick="clearPermitSearch()" style="display: none;">✕</button>
                </div>

                <div class="cert-filter-chips">
                    <button class="cert-filter-chip active" data-filter="all" onclick="setPermitFilter('all')">All</button>
                    <button class="cert-filter-chip" data-filter="linked" onclick="setPermitFilter('linked')">🔗 Linked</button>
                </div>
            </div>

            <!-- Status and Type Filter Row -->
            <div class="cert-search-bar" style="padding-top: 8px; border-top: none;">
                <div class="cert-filters-row">
                    <div class="cert-date-filters">
                        <label>📋 Status:</label>
                        <select id="permitStatusFilter" class="cert-date-select" onchange="applyPermitFilters()">
                            <option value="">All Statuses</option>
                        </select>
                        <label style="margin-left: 16px;">🔨 Type:</label>
                        <select id="permitTypeFilter" class="cert-date-select" onchange="applyPermitFilters()">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Date Filter Row -->
            <div class="cert-search-bar" style="padding-top: 8px; border-top: none;">
                <div class="cert-filters-row">
                    <div class="cert-date-filters">
                        <label>📅 Submitted:</label>
                        <select id="permitDateYear" class="cert-date-select" onchange="applyPermitFilters()">
                            <option value="">Any Year</option>
                        </select>
                        <select id="permitDateMonth" class="cert-date-select" onchange="applyPermitFilters()">
                            <option value="">Any Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <button class="cert-clear-date" onclick="clearPermitDateFilter()">Clear</button>
                    </div>

                    <div class="cert-results-info" id="permitResultsInfo" style="color: var(--gray-500); font-size: 13px; margin-left: auto;"></div>
                </div>
            </div>

            <!-- Permits Table -->
            <div class="cert-table-container">
                <table class="cert-table">
                    <thead>
                        <tr>
                            <th onclick="sortPermits('record_number')">Record #</th>
                            <th onclick="sortPermits('record_type')">Type</th>
                            <th onclick="sortPermits('permit_for')">Permit For</th>
                            <th onclick="sortPermits('address')">Address</th>
                            <th onclick="sortPermits('mbl')">MBL</th>
                            <th onclick="sortPermits('occupancy_type')">Occupancy</th>
                            <th onclick="sortPermits('record_status')">Status</th>
                            <th onclick="sortPermits('date_submitted')">Submitted</th>
                            <th onclick="sortPermits('permit_issued_date')">Issued</th>
                            <th onclick="sortPermits('contractor_name')">Contractor</th>
                            <th>Property</th>
                        </tr>
                    </thead>
                    <tbody id="permitTableBody">
                        <tr><td colspan="11" style="text-align: center; padding: 40px;">Loading permits...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="cert-pagination">
                <button onclick="permitPrevPage()" id="permitPrevBtn" disabled>← Previous</button>
                <span id="permitPageInfo">Page 1</span>
                <button onclick="permitNextPage()" id="permitNextBtn">Next →</button>
            </div>
        </div>
    </div><!-- End Permits View -->

    <!-- Property Detail Modal -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Property Details</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox / Fullscreen Image Viewer -->
    <div class="lightbox-overlay" id="lightboxOverlay" onclick="closeLightbox(event)">
        <button class="lightbox-close" onclick="closeLightbox(event)">&times;</button>
        <button class="lightbox-nav prev" onclick="navigateLightbox(event, -1)">&lsaquo;</button>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightboxImage" src="" alt="">
            <div class="lightbox-caption" id="lightboxCaption"></div>
        </div>
        <button class="lightbox-nav next" onclick="navigateLightbox(event, 1)">&rsaquo;</button>
        <div class="lightbox-counter" id="lightboxCounter"></div>
    </div>

    <!-- Advanced Search Modal -->
    <div class="advanced-search-modal" id="advancedSearchModal">
        <div class="advanced-search-content">
            <div class="advanced-search-header">
                <span class="advanced-search-title">🔍 Advanced Search</span>
                <button class="modal-close" onclick="closeAdvancedSearch()">&times;</button>
            </div>
            <div class="advanced-search-body">
                <div class="advanced-search-row">
                    <div class="advanced-search-field full-width">
                        <label class="advanced-search-label">Address / Location</label>
                        <input type="text" class="advanced-search-input" id="advAddress" placeholder="Enter street address or neighborhood...">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Owner Name</label>
                        <input type="text" class="advanced-search-input" id="advOwner" placeholder="Owner or co-owner name...">
                    </div>
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Parcel ID</label>
                        <input type="text" class="advanced-search-input" id="advParcelId" placeholder="Enter parcel ID...">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Min Assessed Value ($)</label>
                        <input type="number" class="advanced-search-input" id="advMinValue" placeholder="e.g., 100000">
                    </div>
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Max Assessed Value ($)</label>
                        <input type="number" class="advanced-search-input" id="advMaxValue" placeholder="e.g., 500000">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Min Ownership Years</label>
                        <input type="number" class="advanced-search-input" id="advMinOwnership" placeholder="e.g., 10">
                    </div>
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Max Ownership Years</label>
                        <input type="number" class="advanced-search-input" id="advMaxOwnership" placeholder="e.g., 30">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Year Built (Min)</label>
                        <input type="number" class="advanced-search-input" id="advMinYearBuilt" placeholder="e.g., 1950">
                    </div>
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Year Built (Max)</label>
                        <input type="number" class="advanced-search-input" id="advMaxYearBuilt" placeholder="e.g., 2020">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Property Type</label>
                        <select class="advanced-search-input" id="advPropertyType">
                            <option value="">Any Type</option>
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="mixed">Mixed Use</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Neighborhood</label>
                        <input type="text" class="advanced-search-input" id="advNeighborhood" placeholder="Neighborhood name...">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Min Living Area (sqft)</label>
                        <input type="number" class="advanced-search-input" id="advMinLivingArea" placeholder="e.g., 1000">
                    </div>
                    <div class="advanced-search-field">
                        <label class="advanced-search-label">Max Living Area (sqft)</label>
                        <input type="number" class="advanced-search-input" id="advMaxLivingArea" placeholder="e.g., 3000">
                    </div>
                </div>
                <div class="advanced-search-row">
                    <div class="advanced-search-field full-width">
                        <label class="advanced-search-label">Lead Notes Contains</label>
                        <input type="text" class="advanced-search-input" id="advNotes" placeholder="Search in lead notes...">
                    </div>
                </div>
            </div>
            <div class="advanced-search-footer">
                <button class="btn btn-secondary" onclick="clearAdvancedSearch()">Clear All</button>
                <button class="btn btn-primary" onclick="applyAdvancedSearch()">🔍 Search</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://cxcgeumhfjvnuibxnbob.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Y2dldW1oZmp2bnVpYnhuYm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxOTc5MTYsImV4cCI6MjA3NDc3MzkxNn0.5p6YdLSEF54r-LVOPFhD4OpehMXx6K1q8RPWm3XKeS8';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let currentPage = 1;
        const pageSize = 20;
        let selectedProperty = null;
        let currentFilter = 'all';
        let searchQuery = '';
        let leadsCache = {};
        let searchTimeout = null;
        let saveTimeout = null;

        // Lightbox state
        let lightboxImages = [];
        let lightboxCurrentIndex = 0;
        let currentPropertyImages = []; // Stores images for current property modal

        // Lead form state (Phase 1: Manual save control)
        let pendingLeadChanges = {};
        let isLeadFormDirty = false;
        let lastSavedTimestamp = {}; // Track last save time per parcel_id
        
        // New state for enhanced features
        let viewMode = 'cards'; // 'cards' or 'table'
        let selectedProperties = new Set(); // For multi-select
        let currentProperties = []; // Cache current page properties
        let propertyTypeFilter = 'all';
        let sortColumn = 'total_assessed_value';
        let sortDirection = 'desc';
        
        // Advanced search state
        let advancedFilters = {};
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        let searchSuggestionsVisible = false;
        let businessCertParcelIds = []; // Cache of parcel IDs with business certificates

        // Certificate View State
        let certCurrentPage = 1;
        const certPageSize = 50;
        let certFilter = 'all';
        let certSearchQuery = '';
        let certSortColumn = 'expiration_date';
        let certSortDirection = 'asc';
        let certSearchTimeout = null;
        let certTotalCount = 0;
        let currentView = 'properties'; // 'properties' or 'certificates'
        let previousView = null; // Track view before opening modal from certificates
        let certExpYear = '';
        let certExpMonth = '';
        let certDateRangeStart = null;
        let certDateRangeEnd = null;
        let certQuickFilter = null;

        // Permit View State
        let permitCurrentPage = 1;
        const permitPageSize = 50;
        let permitFilter = 'all';
        let permitSearchQuery = '';
        let permitSortColumn = 'date_submitted';
        let permitSortDirection = 'desc';
        let permitSearchTimeout = null;
        let permitTotalCount = 0;
        let permitStatusFilter = '';
        let permitTypeFilter = '';
        let permitDateYear = '';
        let permitDateMonth = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDashboardStats();
            await loadLeadsCounts();
            await loadBusinessCertCount();
            await loadProperties();
            await updateTabCounts();

            // Warn before leaving page with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });
            
            // Search input handler
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchQuery = e.target.value.trim();
                
                // Show/hide clear button
                searchClear.classList.toggle('visible', searchQuery.length > 0);
                
                // Update suggestions as user types
                if (searchQuery.length >= 2) {
                    showSearchSuggestions(searchQuery);
                } else if (searchQuery.length === 0) {
                    showRecentSearches();
                }
                
                searchTimeout = setTimeout(() => {
                    if (searchQuery.length >= 2) {
                        saveRecentSearch(searchQuery);
                    }
                    currentPage = 1;
                    loadProperties();
                    updateSearchResultsInfo();
                }, 300);
            });

            // Search focus/blur handlers
            searchInput.addEventListener('focus', () => {
                if (searchQuery.length === 0) {
                    showRecentSearches();
                } else if (searchQuery.length >= 2) {
                    showSearchSuggestions(searchQuery);
                }
            });

            // Hide suggestions on click outside
            document.addEventListener('click', (e) => {
                const searchContainer = document.getElementById('searchContainer');
                if (!searchContainer.contains(e.target)) {
                    hideSearchSuggestions();
                }
            });

            // Set default filter
            setFilter('all');
        });

        // Load Dashboard Stats from Materialized View
        async function loadDashboardStats() {
            try {
                const { data, error } = await db
                    .from('dashboard_stats')
                    .select('*')
                    .single();

                if (data) {
                    document.getElementById('statTotalProperties').textContent = formatNumber(data.total_properties);
                    document.getElementById('statAvgValue').textContent = '$' + formatNumber(Math.round(data.avg_assessed_value));
                    document.getElementById('statAvgOwnership').textContent = data.avg_ownership_years + ' yrs';
                    document.getElementById('statLongTerm').textContent = formatNumber(data.long_term_owners);
                    document.getElementById('filterLongTermCount').textContent = formatNumber(data.long_term_owners);
                    document.getElementById('lastUpdated').textContent = 'Data as of ' + new Date(data.last_updated).toLocaleDateString();
                }
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        // Load Lead Counts
        async function loadLeadsCounts() {
            try {
                // Get all leads - include id, version for optimistic locking (Phase 4)
                const { data: leads } = await db
                    .from('property_leads')
                    .select('id, parcel_id, status, follow_up_date, priority, notes, contact_name, contact_phone, contact_email, version, updated_at');

                if (leads) {
                    const activeLeads = leads.filter(l => !['closed', 'not_interested'].includes(l.status)).length;
                    const hotLeads = leads.filter(l => l.status === 'hot').length;
                    const today = new Date().toISOString().split('T')[0];
                    const followUps = leads.filter(l => l.follow_up_date === today).length;

                    document.getElementById('statActiveLeads').textContent = activeLeads;
                    document.getElementById('statHotLeads').textContent = hotLeads;
                    document.getElementById('statFollowUps').textContent = followUps;
                    document.getElementById('filterLeadsCount').textContent = leads.length;
                    document.getElementById('filterNewCount').textContent = leads.filter(l => l.status === 'new').length;
                    document.getElementById('filterContactedCount').textContent = leads.filter(l => l.status === 'contacted').length;
                    document.getElementById('filterInterestedCount').textContent = leads.filter(l => l.status === 'interested').length;
                    document.getElementById('filterHotCount').textContent = hotLeads;
                    document.getElementById('filterFollowUpCount').textContent = leads.filter(l => l.follow_up_date).length;
                    document.getElementById('filterNotInterestedCount').textContent = leads.filter(l => l.status === 'not_interested').length;

                    // Cache leads by parcel_id
                    leadsCache = {};
                    leads.forEach(lead => {
                        leadsCache[lead.parcel_id] = lead;
                    });
                }
            } catch (e) {
                console.error('Error loading leads counts:', e);
            }
        }

        // Load Business Certificate Count
        async function loadBusinessCertCount() {
            try {
                const { data, error } = await db
                    .from('business_certificates')
                    .select('linked_parcel_id')
                    .not('linked_parcel_id', 'is', null);

                if (data) {
                    // Get unique parcel IDs
                    businessCertParcelIds = [...new Set(data.map(d => d.linked_parcel_id))];
                    document.getElementById('filterBusinessCount').textContent = businessCertParcelIds.length;
                }
            } catch (e) {
                console.error('Error loading business cert count:', e);
            }
        }

        // Load Properties
        async function loadProperties() {
            const container = document.getElementById('propertyList');
            const tableBody = document.getElementById('propertyTableBody');
            
            if (viewMode === 'cards') {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading properties...</p></div>';
            } else {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Loading...</td></tr>';
            }

            try {
                const from = (currentPage - 1) * pageSize;
                const to = from + pageSize - 1;

                let query = db
                    .from('worcester_data_collection')
                    .select('parcel_id, location, owner_name, co_owner, total_assessed_value, year_built, living_area_sqft, bedrooms, bathrooms, building_style, use_description, use_code, neighborhood, ownership_years, last_sale_date, property_type');

                // Apply text search filter - uses trigram indexes
                if (searchQuery && searchQuery.length >= 2) {
                    query = query.or(`location.ilike.%${searchQuery}%,owner_name.ilike.%${searchQuery}%,parcel_id.ilike.%${searchQuery}%,neighborhood.ilike.%${searchQuery}%`);
                }

                // Apply advanced filters
                if (advancedFilters.address) {
                    query = query.ilike('location', `%${advancedFilters.address}%`);
                }
                if (advancedFilters.owner) {
                    query = query.or(`owner_name.ilike.%${advancedFilters.owner}%,co_owner.ilike.%${advancedFilters.owner}%`);
                }
                if (advancedFilters.parcelId) {
                    query = query.ilike('parcel_id', `%${advancedFilters.parcelId}%`);
                }
                if (advancedFilters.minValue) {
                    query = query.gte('total_assessed_value', advancedFilters.minValue);
                }
                if (advancedFilters.maxValue) {
                    query = query.lte('total_assessed_value', advancedFilters.maxValue);
                }
                if (advancedFilters.minOwnership) {
                    query = query.gte('ownership_years', advancedFilters.minOwnership);
                }
                if (advancedFilters.maxOwnership) {
                    query = query.lte('ownership_years', advancedFilters.maxOwnership);
                }
                if (advancedFilters.minYearBuilt) {
                    query = query.gte('year_built', advancedFilters.minYearBuilt);
                }
                if (advancedFilters.maxYearBuilt) {
                    query = query.lte('year_built', advancedFilters.maxYearBuilt);
                }
                if (advancedFilters.neighborhood) {
                    query = query.ilike('neighborhood', `%${advancedFilters.neighborhood}%`);
                }
                if (advancedFilters.minLivingArea) {
                    query = query.gte('living_area_sqft', advancedFilters.minLivingArea);
                }
                if (advancedFilters.maxLivingArea) {
                    query = query.lte('living_area_sqft', advancedFilters.maxLivingArea);
                }
                if (advancedFilters.propertyType && propertyTypeFilter === 'all') {
                    query = query.eq('property_type', advancedFilters.propertyType);
                }

                // Apply lead filters
                if (currentFilter === 'leads') {
                    let leadParcelIds = Object.keys(leadsCache);
                    // Filter by notes if searching in notes
                    if (advancedFilters.notes) {
                        leadParcelIds = leadParcelIds.filter(id => 
                            (leadsCache[id].notes || '').toLowerCase().includes(advancedFilters.notes.toLowerCase())
                        );
                    }
                    if (leadParcelIds.length > 0) {
                        query = query.in('parcel_id', leadParcelIds);
                    } else {
                        showEmptyState(advancedFilters.notes ? 'No leads match your notes search.' : 'No leads yet. Click a property to add it as a lead.');
                        updatePagination(0);
                        return;
                    }
                } else if (advancedFilters.notes) {
                    // If searching notes but not in leads filter, only show properties with matching notes
                    const matchingIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => (lead.notes || '').toLowerCase().includes(advancedFilters.notes.toLowerCase()))
                        .map(([id, _]) => id);
                    if (matchingIds.length > 0) {
                        query = query.in('parcel_id', matchingIds);
                    } else {
                        showEmptyState('No properties found with matching notes.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'hot') {
                    const hotParcelIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => lead.status === 'hot')
                        .map(([id, _]) => id);
                    if (hotParcelIds.length > 0) {
                        query = query.in('parcel_id', hotParcelIds);
                    } else {
                        showEmptyState('No hot leads yet.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'new') {
                    const newParcelIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => lead.status === 'new')
                        .map(([id, _]) => id);
                    if (newParcelIds.length > 0) {
                        query = query.in('parcel_id', newParcelIds);
                    } else {
                        showEmptyState('No new leads.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'contacted') {
                    const contactedParcelIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => lead.status === 'contacted')
                        .map(([id, _]) => id);
                    if (contactedParcelIds.length > 0) {
                        query = query.in('parcel_id', contactedParcelIds);
                    } else {
                        showEmptyState('No contacted leads yet.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'interested') {
                    const interestedParcelIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => lead.status === 'interested')
                        .map(([id, _]) => id);
                    if (interestedParcelIds.length > 0) {
                        query = query.in('parcel_id', interestedParcelIds);
                    } else {
                        showEmptyState('No interested leads yet.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'not_interested') {
                    const notInterestedParcelIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => lead.status === 'not_interested')
                        .map(([id, _]) => id);
                    if (notInterestedParcelIds.length > 0) {
                        query = query.in('parcel_id', notInterestedParcelIds);
                    } else {
                        showEmptyState('No leads marked as not interested.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'follow_up') {
                    const followUpParcelIds = Object.entries(leadsCache)
                        .filter(([_, lead]) => lead.follow_up_date)
                        .map(([id, _]) => id);
                    if (followUpParcelIds.length > 0) {
                        query = query.in('parcel_id', followUpParcelIds);
                    } else {
                        showEmptyState('No follow-ups scheduled.');
                        updatePagination(0);
                        return;
                    }
                } else if (currentFilter === 'long_term') {
                    query = query.gte('ownership_years', 20);
                } else if (currentFilter === 'has_business') {
                    if (businessCertParcelIds.length > 0) {
                        query = query.in('parcel_id', businessCertParcelIds);
                    } else {
                        showEmptyState('No properties with business certificates found.');
                        updatePagination(0);
                        return;
                    }
                }

                // Apply property type filter (uses indexed column)
                if (propertyTypeFilter !== 'all') {
                    query = query.eq('property_type', propertyTypeFilter);
                }

                // Determine sort order
                const ascending = sortDirection === 'asc';

                // Order and paginate
                const { data, error } = await query
                    .order(sortColumn, { ascending: ascending, nullsLast: true })
                    .range(from, to);

                if (error) throw error;

                currentProperties = data || [];
                renderProperties(currentProperties);
                updatePagination(currentProperties.length);
                updateSortIndicators();
            } catch (e) {
                console.error('Error loading properties:', e);
                showEmptyState(`Error loading properties: ${e.message}`);
            }
        }

        // Show empty state for both views
        function showEmptyState(message) {
            const container = document.getElementById('propertyList');
            const tableBody = document.getElementById('propertyTableBody');
            
            if (viewMode === 'cards') {
                container.innerHTML = `<div class="loading"><p>${message}</p></div>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-500);">${message}</td></tr>`;
            }
        }

        // Render Properties (supports both card and table views)
        function renderProperties(properties) {
            if (properties.length === 0) {
                showEmptyState('No properties found.');
                return;
            }

            if (viewMode === 'cards') {
                renderCardsView(properties);
            } else {
                renderTableView(properties);
            }
        }

        // Render Cards View
        function renderCardsView(properties) {
            const container = document.getElementById('propertyList');
            
            container.innerHTML = properties.map(prop => {
                const lead = leadsCache[prop.parcel_id];
                const isSelected = selectedProperty?.parcel_id === prop.parcel_id;
                const hasLead = !!lead;
                const isHot = lead?.status === 'hot';
                const isLongTerm = prop.ownership_years >= 20;
                const isChecked = selectedProperties.has(prop.parcel_id);
                const hasBusiness = businessCertParcelIds.includes(prop.parcel_id);

                return `
                    <div class="property-card ${isSelected ? 'selected' : ''} ${hasLead ? 'has-lead' : ''} ${isHot ? 'hot' : ''}" 
                         onclick="selectProperty('${prop.parcel_id}')"
                         ondblclick="openPropertyModal('${prop.parcel_id}')">
                        <div class="property-card-checkbox-area" onclick="event.stopPropagation();">
                            <input type="checkbox" class="property-checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="togglePropertySelection('${prop.parcel_id}', this.checked)">
                        </div>
                        <div class="property-main">
                            <div class="property-address">${escapeHtml(prop.location || 'N/A')}</div>
                            <div class="property-owner">${escapeHtml(prop.owner_name || 'N/A')}</div>
                            <div class="property-meta">
                                ${prop.ownership_years ? `<span style="${isLongTerm ? 'color: var(--warning); font-weight: 600;' : ''}">⏳ ${prop.ownership_years} yrs</span>` : ''}
                                ${prop.year_built ? `<span>🏗️ ${prop.year_built}</span>` : ''}
                                ${prop.living_area_sqft ? `<span>📐 ${formatNumber(prop.living_area_sqft)} sqft</span>` : ''}
                                ${prop.bedrooms ? `<span>🛏️ ${prop.bedrooms} bed</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px;">
                                ${lead ? `<span class="lead-badge ${lead.status}">${formatStatus(lead.status)}</span>` : ''}
                                ${isLongTerm && !lead ? `<span class="lead-badge" style="background: #fef3c7; color: #92400e;">⏳ Long-term</span>` : ''}
                                ${hasBusiness ? `<span class="lead-badge" style="background: #dbeafe; color: #1e40af;">🏪 Business</span>` : ''}
                                ${getPropertyTypeBadge(prop)}
                            </div>
                        </div>
                        <div class="property-value">
                            <div class="amount">${prop.total_assessed_value ? '$' + formatNumber(prop.total_assessed_value) : 'N/A'}</div>
                            <div class="label">Assessed</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Table View
        function renderTableView(properties) {
            const tableBody = document.getElementById('propertyTableBody');
            
            tableBody.innerHTML = properties.map(prop => {
                const lead = leadsCache[prop.parcel_id];
                const isSelected = selectedProperty?.parcel_id === prop.parcel_id;
                const isLongTerm = prop.ownership_years >= 20;
                const isChecked = selectedProperties.has(prop.parcel_id);
                const propertyType = classifyPropertyType(prop);
                const hasBusiness = businessCertParcelIds.includes(prop.parcel_id);

                return `
                    <tr class="${isSelected ? 'selected' : ''} ${isChecked ? 'row-checked' : ''}"
                        onclick="selectProperty('${prop.parcel_id}')"
                        ondblclick="openPropertyModal('${prop.parcel_id}')">
                        <td onclick="event.stopPropagation();">
                            <input type="checkbox" class="property-checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="togglePropertySelection('${prop.parcel_id}', this.checked)">
                        </td>
                        <td class="address-cell">
                            ${escapeHtml(prop.location || 'N/A')}
                            ${hasBusiness ? '<span class="has-business-cert">🏪</span>' : ''}
                        </td>
                        <td class="owner-cell" title="${escapeHtml(prop.owner_name || '')}">${escapeHtml(prop.owner_name || 'N/A')}</td>
                        <td class="value-cell">${prop.total_assessed_value ? '$' + formatNumber(prop.total_assessed_value) : 'N/A'}</td>
                        <td class="ownership-cell ${isLongTerm ? 'long-term' : ''}">${prop.ownership_years ? prop.ownership_years + ' yrs' : 'N/A'}</td>
                        <td>${prop.year_built || 'N/A'}</td>
                        <td><span class="table-badge ${propertyType}">${propertyType}</span></td>
                        <td>${lead ? `<span class="lead-badge ${lead.status}">${formatStatus(lead.status)}</span>` : '-'}</td>
                        <td onclick="event.stopPropagation();">
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="openPropertyModal('${prop.parcel_id}')">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Classify property type - uses database column if available
        function classifyPropertyType(prop) {
            if (prop.property_type && prop.property_type !== 'other') {
                return prop.property_type;
            }
            // Fallback to description-based classification
            const desc = (prop.use_description || '').toUpperCase();
            if (desc.includes('COMMERCIAL') || desc.includes('OFFICE') || desc.includes('RETAIL') || desc.includes('INDUST') || desc.includes('WAREHOUSE')) {
                return 'commercial';
            } else if (desc.includes('MIXED') || desc.includes('APT')) {
                return 'mixed';
            }
            return 'residential';
        }

        // Get property type badge for card view
        function getPropertyTypeBadge(prop) {
            const type = classifyPropertyType(prop);
            if (type === 'commercial') {
                return '<span class="lead-badge" style="background: #fef3c7; color: #92400e;">🏢 Commercial</span>';
            } else if (type === 'mixed') {
                return '<span class="lead-badge" style="background: #e0e7ff; color: #3730a3;">🏘️ Mixed</span>';
            }
            return '';
        }

        // Select Property
        async function selectProperty(parcelId) {
            // Check for unsaved changes before switching
            if (hasUnsavedChanges()) {
                if (!confirm('You have unsaved changes. Discard and switch properties?')) {
                    return;
                }
                clearPendingChanges();
            }

            // Find property from current list
            const cards = document.querySelectorAll('.property-card');
            cards.forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Load full property data
            const { data: prop } = await db
                .from('worcester_data_collection')
                .select('*')
                .eq('parcel_id', parcelId)
                .single();

            if (prop) {
                selectedProperty = prop;
                renderLeadPanel(prop);
            }
        }

        // Render Lead Panel
        function renderLeadPanel(prop) {
            const lead = leadsCache[prop.parcel_id] || {};
            const content = document.getElementById('leadPanelContent');

            const isLongTerm = prop.ownership_years >= 20;
            content.innerHTML = `
                <div class="lead-property-info">
                    <div class="lead-property-address">${escapeHtml(prop.location || 'N/A')}</div>
                    ${isLongTerm ? `<div style="background: #fef3c7; color: #92400e; padding: 8px 12px; border-radius: 6px; margin: 8px 0; font-size: 13px; font-weight: 600;">⏳ Long-term owner: ${prop.ownership_years} years since last sale</div>` : ''}
                    <div class="lead-property-details">
                        <div class="lead-property-detail">
                            <span class="label">Owner</span>
                            <span class="value">${escapeHtml(prop.owner_name || 'N/A')}</span>
                        </div>
                        <div class="lead-property-detail">
                            <span class="label">Assessed Value</span>
                            <span class="value">${prop.total_assessed_value ? '$' + formatNumber(prop.total_assessed_value) : 'N/A'}</span>
                        </div>
                        <div class="lead-property-detail">
                            <span class="label">Ownership</span>
                            <span class="value" style="${isLongTerm ? 'color: var(--warning); font-weight: 700;' : ''}">${prop.ownership_years ? prop.ownership_years + ' years' : 'N/A'}</span>
                        </div>
                        <div class="lead-property-detail">
                            <span class="label">Last Sale</span>
                            <span class="value">${prop.last_sale_date || 'N/A'}</span>
                        </div>
                        <div class="lead-property-detail">
                            <span class="label">Year Built</span>
                            <span class="value">${prop.year_built || 'N/A'}</span>
                        </div>
                        <div class="lead-property-detail">
                            <span class="label">Use</span>
                            <span class="value">${escapeHtml(prop.use_description || 'N/A')}</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 12px; width: 100%;" onclick="openPropertyModal('${prop.parcel_id}')">
                        View Full Details
                    </button>
                </div>

                <div id="dirtyIndicator" class="dirty-indicator" style="display: none;"></div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Status</label>
                    <div class="status-buttons">
                        <button class="status-btn ${lead.status === 'new' || !lead.status ? 'active' : ''}" onclick="selectStatus(this, 'new')">New</button>
                        <button class="status-btn ${lead.status === 'contacted' ? 'active' : ''}" onclick="selectStatus(this, 'contacted')">Contacted</button>
                        <button class="status-btn ${lead.status === 'interested' ? 'active' : ''}" onclick="selectStatus(this, 'interested')">Interested</button>
                        <button class="status-btn hot ${lead.status === 'hot' ? 'active' : ''}" onclick="selectStatus(this, 'hot')">🔥 Hot</button>
                        <button class="status-btn ${lead.status === 'follow_up' ? 'active' : ''}" onclick="selectStatus(this, 'follow_up')">Follow-up</button>
                        <button class="status-btn ${lead.status === 'not_interested' ? 'active' : ''}" onclick="selectStatus(this, 'not_interested')">Not Int.</button>
                    </div>
                </div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Priority</label>
                    <div class="priority-stars" id="priorityStars">
                        ${[1,2,3,4,5].map(i => `
                            <span class="priority-star ${(lead.priority || 3) >= i ? 'active' : ''}" onclick="selectPriority(${i})">★</span>
                        `).join('')}
                    </div>
                </div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Follow-up Date</label>
                    <input type="date" class="lead-input" id="followUpDate" value="${lead.follow_up_date || ''}" onchange="setLeadField('follow_up_date', this.value)">
                </div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Contact Name</label>
                    <input type="text" class="lead-input" id="contactName" value="${escapeHtml(lead.contact_name || '')}" placeholder="Contact name..." oninput="setLeadField('contact_name', this.value)">
                </div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Contact Phone</label>
                    <input type="tel" class="lead-input" id="contactPhone" value="${escapeHtml(lead.contact_phone || '')}" placeholder="Phone number..." oninput="setLeadField('contact_phone', this.value)">
                    <div class="field-error" id="contactPhoneError" style="display: none;"></div>
                </div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Contact Email</label>
                    <input type="email" class="lead-input" id="contactEmail" value="${escapeHtml(lead.contact_email || '')}" placeholder="Email address..." oninput="setLeadField('contact_email', this.value)">
                    <div class="field-error" id="contactEmailError" style="display: none;"></div>
                </div>

                <div class="lead-form-section">
                    <label class="lead-form-label">Notes</label>
                    <textarea class="lead-textarea" id="leadNotes" placeholder="Add notes about this lead..." oninput="setLeadField('notes', this.value)">${escapeHtml(lead.notes || '')}</textarea>
                </div>

                <div class="lead-actions" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                    <button type="button" class="btn btn-primary" id="saveLeadBtn" onclick="saveLeadForm()" title="Save all changes">
                        💾 Save Lead
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelLeadChanges()" title="Discard changes">
                        ↩ Cancel
                    </button>
                    ${lead.id ? `
                        <button type="button" class="btn btn-danger" onclick="deleteLead('${prop.parcel_id}')" title="Remove from leads">
                            🗑️ Delete
                        </button>
                    ` : ''}
                </div>

                <div id="lastSavedDisplay" class="last-saved-display" style="display: ${lastSavedTimestamp[prop.parcel_id] ? 'block' : 'none'};">
                    ${formatLastSaved(prop.parcel_id)}
                </div>
            `;
        }

        // Handle Reset Button Click
        function handleResetClick(parcelId) {
            console.log('Reset clicked for parcel:', parcelId);
            resetLeadForm(parcelId);
        }

        /*
        // Reset ALL Leads - deletes all lead data
        async function resetAllLeads() {
            const leadCount = Object.keys(leadsCache).length;

            if (leadCount === 0) {
                showToast('No leads to reset', 'info');
                return;
            }

            if (!confirm(`DELETE ALL ${leadCount} LEADS?\n\nThis will permanently remove all lead data including:\n- All statuses\n- All notes\n- All contact information\n- All follow-up dates\n\nThis action cannot be undone!`)) {
                return;
            }

            // Double confirmation for safety
            if (!confirm(`Are you absolutely sure? Type OK to confirm deletion of ${leadCount} leads.`)) {
                return;
            }

            try {
                // Delete all leads from database
                const { error } = await db
                    .from('property_leads')
                    .delete()
                    .neq('id', 0); // This deletes all rows

                if (error) throw error;

                // Clear cache
                leadsCache = {};

                // Refresh UI
                await loadLeadsCounts();
                await loadProperties();

                // Clear lead panel
                document.getElementById('leadPanelContent').textContent = 'All leads have been cleared';

                selectedProperty = null;

                showToast(`All ${leadCount} leads have been deleted`, 'success');
            } catch (e) {
                console.error('Error resetting all leads:', e);
                showToast('Error resetting leads: ' + e.message, 'error');
            }
        }
        */

        // Reset Lead Form - clears all fields to defaults
        async function resetLeadForm(parcelId) {
            console.log('resetLeadForm called with:', parcelId);
            const existingLead = leadsCache[parcelId];
            
            if (existingLead?.id) {
                // Lead exists in database - confirm and reset it
                if (!confirm('Reset this lead? This will clear all notes, contact info, and set status back to "New".')) return;

                try {
                    const { data, error } = await db
                        .from('property_leads')
                        .update({
                            status: 'new',
                            priority: 3,
                            notes: null,
                            follow_up_date: null,
                            contact_name: null,
                            contact_phone: null,
                            contact_email: null,
                            last_contact_date: null
                        })
                        .eq('parcel_id', parcelId)
                        .select()
                        .single();

                    if (error) throw error;

                    // Update cache with reset data
                    leadsCache[parcelId] = data;
                    
                    // Refresh UI
                    await loadLeadsCounts();
                    loadProperties();
                    
                    showToast('✓ Lead has been reset to defaults', 'success');
                } catch (e) {
                    console.error('Error resetting lead:', e);
                    showToast('Error resetting lead: ' + e.message, 'error');
                    return;
                }
            } else {
                // No lead in database yet - just clear the cached data
                delete leadsCache[parcelId];
                showToast('✓ Form cleared', 'success');
            }
            
            // Re-render panel with reset/cleared data
            if (selectedProperty?.parcel_id === parcelId) {
                renderLeadPanel(selectedProperty);
            }
        }

        // Update Lead Status
        async function updateLeadStatus(status) {
            if (!selectedProperty) return;
            await saveLead({ status });
            showToast('Status updated', 'success');
        }

        // Update Lead Priority
        async function updateLeadPriority(priority) {
            if (!selectedProperty) return;
            await saveLead({ priority });
            renderLeadPanel(selectedProperty); // Re-render to update stars
            showToast('Priority updated', 'success');
        }

        // Update Lead Field
        async function updateLeadField(field, value) {
            if (!selectedProperty) return;
            await saveLead({ [field]: value || null });
        }

        // ==========================================
        // Phase 1: Manual Save Control Functions
        // ==========================================

        // Track field changes without saving to database
        function setLeadField(field, value) {
            pendingLeadChanges[field] = value;
            isLeadFormDirty = true;
            updateDirtyIndicator();

            // Real-time validation for fields with rules
            const fieldIdMap = {
                contact_email: 'contactEmail',
                contact_phone: 'contactPhone'
            };
            if (fieldIdMap[field]) {
                const result = validateField(field, value);
                showFieldError(fieldIdMap[field], result.message);
            }
        }

        // Check if form has unsaved changes
        function hasUnsavedChanges() {
            return isLeadFormDirty && Object.keys(pendingLeadChanges).length > 0;
        }

        // Clear pending changes
        function clearPendingChanges() {
            pendingLeadChanges = {};
            isLeadFormDirty = false;
            updateDirtyIndicator();
        }

        // Update dirty state indicator in UI
        function updateDirtyIndicator() {
            const indicator = document.getElementById('dirtyIndicator');
            if (!indicator) return;

            if (isLeadFormDirty && Object.keys(pendingLeadChanges).length > 0) {
                indicator.textContent = '● Unsaved changes';
                indicator.style.display = 'block';
            } else {
                indicator.textContent = '';
                indicator.style.display = 'none';
            }
        }

        // Save all pending changes to database
        async function saveLeadForm() {
            if (!selectedProperty) return;

            if (Object.keys(pendingLeadChanges).length === 0) {
                showToast('No changes to save', 'info');
                return;
            }

            // Validate before saving
            const { isValid, errors } = validateLeadForm();
            if (!isValid) {
                showToast('Please fix validation errors before saving', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveLeadBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.classList.add('btn-loading');
            }

            const parcelId = selectedProperty.parcel_id;
            const result = await saveLeadWithRetry(pendingLeadChanges);

            if (result.success) {
                // Update timestamp on success
                lastSavedTimestamp[parcelId] = new Date();
                clearPendingChanges();
                updateLastSavedDisplay();
                showToast('Lead saved successfully', 'success');
            } else {
                showToast('Failed to save after 3 attempts. Please try again.', 'error');
            }

            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('btn-loading');
            }
        }

        // Discard pending changes and reset form
        function cancelLeadChanges() {
            if (!hasUnsavedChanges()) {
                showToast('No changes to discard', 'info');
                return;
            }

            if (confirm('Discard unsaved changes?')) {
                clearPendingChanges();
                if (selectedProperty) {
                    renderLeadPanel(selectedProperty);
                }
                showToast('Changes discarded', 'info');
            }
        }

        // Legacy: Debounced Update Field (kept for backwards compatibility, but no longer used)
        function debouncedUpdateField(field, value) {
            // Now just tracks changes locally instead of auto-saving
            setLeadField(field, value);
        }

        // Select status button (UI update + track change)
        function selectStatus(btn, status) {
            // Update UI - remove active from all, add to clicked
            const buttons = btn.parentElement.querySelectorAll('.status-btn');
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Track the change
            setLeadField('status', status);
        }

        // Select priority stars (UI update + track change)
        function selectPriority(priority) {
            // Update UI - fill stars up to selected
            const stars = document.querySelectorAll('#priorityStars .priority-star');
            stars.forEach((star, index) => {
                if (index < priority) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            // Track the change
            setLeadField('priority', priority);
        }

        // ==========================================
        // Phase 2: Validation Functions
        // ==========================================

        const validationRules = {
            contact_email: {
                pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                message: 'Please enter a valid email address'
            },
            contact_phone: {
                pattern: /^[\d\s\-\(\)\+\.]{7,}$/,
                message: 'Please enter a valid phone number (min 7 digits)'
            }
        };

        // Validate a single field
        function validateField(field, value) {
            const rule = validationRules[field];
            if (!rule || !value || value.trim() === '') {
                return { valid: true, message: null };
            }
            const valid = rule.pattern.test(value);
            return {
                valid,
                message: valid ? null : rule.message
            };
        }

        // Show or clear field error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(fieldId + 'Error');

            if (field) {
                if (message) {
                    field.classList.add('input-error');
                } else {
                    field.classList.remove('input-error');
                }
            }

            if (errorEl) {
                errorEl.textContent = message || '';
                errorEl.style.display = message ? 'block' : 'none';
            }
        }

        // Validate all pending changes
        function validateLeadForm() {
            let isValid = true;
            const errors = [];

            // Clear previous errors
            Object.keys(validationRules).forEach(field => {
                const fieldIdMap = {
                    contact_email: 'contactEmail',
                    contact_phone: 'contactPhone'
                };
                showFieldError(fieldIdMap[field], null);
            });

            // Validate each pending change
            for (const [field, value] of Object.entries(pendingLeadChanges)) {
                const result = validateField(field, value);
                if (!result.valid) {
                    isValid = false;
                    errors.push(result.message);
                    const fieldIdMap = {
                        contact_email: 'contactEmail',
                        contact_phone: 'contactPhone'
                    };
                    if (fieldIdMap[field]) {
                        showFieldError(fieldIdMap[field], result.message);
                    }
                }
            }

            return { isValid, errors };
        }

        // ==========================================
        // Phase 3: Better Feedback Functions
        // ==========================================

        // Format last saved timestamp for display
        function formatLastSaved(parcelId) {
            const timestamp = lastSavedTimestamp[parcelId];
            if (!timestamp) return '';

            const now = new Date();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (seconds < 10) return 'Last saved: just now';
            if (seconds < 60) return `Last saved: ${seconds} seconds ago`;
            if (minutes < 60) return `Last saved: ${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `Last saved: ${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `Last saved: ${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}`;
        }

        // Update last saved display
        function updateLastSavedDisplay() {
            const display = document.getElementById('lastSavedDisplay');
            if (display && selectedProperty) {
                const text = formatLastSaved(selectedProperty.parcel_id);
                display.textContent = text;
                display.style.display = text ? 'block' : 'none';
            }
        }

        // Save with retry logic
        async function saveLeadWithRetry(updates, maxRetries = 3) {
            let lastError;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    await saveLead(updates);
                    return { success: true };
                } catch (error) {
                    lastError = error;
                    console.warn(`Save attempt ${attempt} failed:`, error.message);

                    if (attempt < maxRetries) {
                        // Exponential backoff: 1s, 2s, 4s
                        const delay = Math.pow(2, attempt - 1) * 1000;
                        await new Promise(r => setTimeout(r, delay));
                    }
                }
            }

            return { success: false, error: lastError };
        }

        // Save Lead with Optimistic Locking (Phase 4)
        async function saveLead(updates) {
            if (!selectedProperty) return;

            const parcelId = selectedProperty.parcel_id;
            const existingLead = leadsCache[parcelId];

            try {
                if (existingLead && existingLead.id) {
                    // Update existing lead with optimistic locking
                    const currentVersion = existingLead.version || 1;

                    const { data, error, count } = await db
                        .from('property_leads')
                        .update(updates)
                        .eq('parcel_id', parcelId)
                        .eq('version', currentVersion) // Only update if version matches
                        .select()
                        .single();

                    if (error) {
                        // Check if it's a "no rows returned" error (version mismatch)
                        if (error.code === 'PGRST116') {
                            throw new Error('CONFLICT');
                        }
                        throw error;
                    }

                    if (!data) {
                        // No rows updated - version mismatch (conflict)
                        throw new Error('CONFLICT');
                    }

                    leadsCache[parcelId] = data;
                } else {
                    // Create new lead (no version check needed for insert)
                    const { data, error } = await db
                        .from('property_leads')
                        .insert({ parcel_id: parcelId, version: 1, ...updates })
                        .select()
                        .single();

                    if (error) throw error;
                    leadsCache[parcelId] = data;
                }

                // Refresh counts and list
                await loadLeadsCounts();
                loadProperties();
            } catch (e) {
                console.error('Error saving lead:', e);

                if (e.message === 'CONFLICT') {
                    // Handle version conflict
                    const shouldRefresh = confirm(
                        'This lead was modified by another user or browser tab.\n\n' +
                        'Click OK to refresh with the latest data (your changes will be lost).\n' +
                        'Click Cancel to keep your changes and try saving again.'
                    );

                    if (shouldRefresh) {
                        await refreshLeadData(parcelId);
                    }

                    throw new Error('Version conflict - lead was modified elsewhere');
                }

                throw e;
            }
        }

        // Refresh lead data from database (for conflict resolution)
        async function refreshLeadData(parcelId) {
            try {
                const { data, error } = await db
                    .from('property_leads')
                    .select('*')
                    .eq('parcel_id', parcelId)
                    .single();

                if (error) throw error;

                if (data) {
                    leadsCache[parcelId] = data;
                    clearPendingChanges();

                    if (selectedProperty && selectedProperty.parcel_id === parcelId) {
                        renderLeadPanel(selectedProperty);
                    }

                    showToast('Lead data refreshed from server', 'info');
                }
            } catch (e) {
                console.error('Error refreshing lead data:', e);
                showToast('Failed to refresh lead data', 'error');
            }
        }

        // Delete Lead
        async function deleteLead(parcelId) {
            if (!confirm('Remove this property from your leads?')) return;

            try {
                const { error } = await db
                    .from('property_leads')
                    .delete()
                    .eq('parcel_id', parcelId);

                if (error) throw error;

                delete leadsCache[parcelId];
                await loadLeadsCounts();
                loadProperties();
                
                // Re-render panel
                if (selectedProperty?.parcel_id === parcelId) {
                    renderLeadPanel(selectedProperty);
                }

                showToast('Lead removed', 'success');
            } catch (e) {
                console.error('Error deleting lead:', e);
                showToast('Error removing lead', 'error');
            }
        }

        // Open Property Modal
        async function openPropertyModal(parcelId) {
            const modal = document.getElementById('propertyModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');

            modal.classList.add('active');
            body.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';

            try {
                // Check if parcelId is in MBL format (contains dashes like "03-034-00016")
                const isMBLFormat = parcelId && parcelId.includes('-');
                const lookupField = isMBLFormat ? 'acct_number' : 'parcel_id';

                const { data: prop, error } = await db
                    .from('worcester_data_collection')
                    .select('*')
                    .eq(lookupField, parcelId)
                    .maybeSingle();

                if (error) throw error;

                if (!prop) {
                    title.textContent = `Parcel ${parcelId}`;
                    body.innerHTML = `<div class="loading"><p>No property found with parcel ID: ${parcelId}</p><p style="font-size: 13px; color: var(--gray-500); margin-top: 8px;">This permit may be linked to a parcel that doesn't exist in the properties database.</p></div>`;
                    return;
                }

                title.textContent = prop.location || `Parcel ${parcelId}`;
                body.innerHTML = renderPropertyDetails(prop);

                // Initialize the property map
                initPropertyModalMap(prop.location);

                // Load business certificates asynchronously
                loadBusinessCertificates(prop.location);

                // Load building permits asynchronously (use acct_number which matches MBL format in permits)
                loadBuildingPermitsForProperty(prop.acct_number);

                // Load AI analysis section
                loadAIAnalysisSection(prop);
            } catch (e) {
                body.innerHTML = `<div class="loading"><p>Error: ${e.message}</p></div>`;
            }
        }

        // Render Property Details - Comprehensive View
        function renderPropertyDetails(prop) {
            const photos = prop.photos || [];
            const layouts = prop.layouts || [];
            const buildings = prop.buildings || [];
            const salesHistory = prop.sales_history || [];
            const valuationHistory = prop.valuation_history || [];
            const landDetails = prop.land_details || {};
            const outbuildings = prop.outbuildings || [];
            const extraFeatures = prop.extra_features || [];
            const exemptions = prop.exemptions || [];

            // Store images for lightbox
            currentPropertyImages = [
                ...photos.map(p => ({ url: p.url, caption: p.description || p.photo_type || 'Photo' })),
                ...layouts.map(l => ({ url: l.url, caption: l.description || l.layout_type || 'Layout' }))
            ];
            console.log('Property images stored for lightbox:', currentPropertyImages.length, 'total images');

            return `
                <div class="detail-section">
                    <div class="detail-section-title">Basic Information</div>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="label">Parcel ID</div><div class="value">${prop.parcel_id}</div></div>
                        <div class="detail-item"><div class="label">Account #</div><div class="value">${escapeHtml(prop.acct_number || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">MBLU</div><div class="value">${escapeHtml(prop.mblu || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Location</div><div class="value">${escapeHtml(prop.location || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Street</div><div class="value">${escapeHtml(prop.street_name || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Neighborhood</div><div class="value">${escapeHtml(prop.neighborhood || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Zoning</div><div class="value">${escapeHtml(prop.zoning || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Use Code</div><div class="value">${escapeHtml(prop.use_code || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Use Description</div><div class="value">${escapeHtml(prop.use_description || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Property Type</div><div class="value"><span class="table-badge ${prop.property_type || 'other'}">${escapeHtml(prop.property_type || 'N/A')}</span></div></div>
                        <div class="detail-item"><div class="label">Building Count</div><div class="value">${prop.building_count || 'N/A'}</div></div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">Location Map</div>
                    <div id="property-modal-map" style="height: 250px; border-radius: 8px; background: var(--gray-100);"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <div id="property-modal-map-status" style="font-size: 12px; color: var(--gray-500);"></div>
                        <button id="open-google-maps-btn" onclick="openGoogleMaps()" style="display: none; padding: 6px 12px; font-size: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Open in Google Maps
                        </button>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">Owner Information</div>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="label">Owner</div><div class="value">${escapeHtml(prop.owner_name || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Co-Owner</div><div class="value">${escapeHtml(prop.co_owner || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Ownership Years</div><div class="value" style="${prop.ownership_years >= 20 ? 'color: var(--warning); font-weight: 700;' : ''}">${prop.ownership_years ? prop.ownership_years + ' years' : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Last Sale Date</div><div class="value">${prop.last_sale_date || 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Last Sale Price</div><div class="value">${prop.last_sale_price ? '$' + formatNumber(prop.last_sale_price) : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Book & Page</div><div class="value">${escapeHtml(prop.book_page || 'N/A')}</div></div>
                        <div class="detail-item" style="grid-column: span 2;"><div class="label">Mailing Address</div><div class="value">${escapeHtml(prop.owner_mailing_address || 'N/A')}</div></div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">Assessment & Taxes</div>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="label">Total Assessed</div><div class="value" style="font-weight: 700; color: var(--primary);">${prop.total_assessed_value ? '$' + formatNumber(prop.total_assessed_value) : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Land Value</div><div class="value">${prop.land_value ? '$' + formatNumber(prop.land_value) : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Improvements</div><div class="value">${prop.improvements_value ? '$' + formatNumber(prop.improvements_value) : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Tax Amount</div><div class="value">${prop.tax_amount ? '$' + formatNumber(prop.tax_amount) : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Tax Year</div><div class="value">${prop.tax_year || 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Tax Rate</div><div class="value">${prop.tax_rate || 'N/A'}</div></div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">Property Details</div>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="label">Year Built</div><div class="value">${prop.year_built || 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Living Area</div><div class="value">${prop.living_area_sqft ? formatNumber(prop.living_area_sqft) + ' sqft' : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Lot Size (sqft)</div><div class="value">${prop.lot_size_sqft ? formatNumber(prop.lot_size_sqft) + ' sqft' : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Lot Size (acres)</div><div class="value">${prop.lot_size_acres ? prop.lot_size_acres + ' acres' : 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Total Rooms</div><div class="value">${prop.total_rooms || 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Bedrooms</div><div class="value">${prop.bedrooms || 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Bathrooms</div><div class="value">${prop.bathrooms || 'N/A'}</div></div>
                        <div class="detail-item"><div class="label">Style</div><div class="value">${escapeHtml(prop.building_style || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Exterior Wall</div><div class="value">${escapeHtml(prop.exterior_wall || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Roof Structure</div><div class="value">${escapeHtml(prop.roof_structure || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">Heat Type</div><div class="value">${escapeHtml(prop.heat_type || 'N/A')}</div></div>
                        <div class="detail-item"><div class="label">A/C Type</div><div class="value">${escapeHtml(prop.ac_type || 'N/A')}</div></div>
                    </div>
                </div>

                ${Object.keys(landDetails).length > 0 && !landDetails['No Data for Land'] ? `
                <div class="detail-section">
                    <div class="detail-section-title">Land Details</div>
                    <div class="detail-grid">
                        ${landDetails.frontage ? `<div class="detail-item"><div class="label">Frontage</div><div class="value">${landDetails.frontage} ft</div></div>` : ''}
                        ${landDetails.depth ? `<div class="detail-item"><div class="label">Depth</div><div class="value">${landDetails.depth} ft</div></div>` : ''}
                        ${landDetails.topography ? `<div class="detail-item"><div class="label">Topography</div><div class="value">${escapeHtml(landDetails.topography)}</div></div>` : ''}
                        ${landDetails.utilities ? `<div class="detail-item"><div class="label">Utilities</div><div class="value">${escapeHtml(landDetails.utilities)}</div></div>` : ''}
                        ${landDetails.street_type ? `<div class="detail-item"><div class="label">Street Type</div><div class="value">${escapeHtml(landDetails.street_type)}</div></div>` : ''}
                        ${landDetails.traffic ? `<div class="detail-item"><div class="label">Traffic</div><div class="value">${escapeHtml(landDetails.traffic)}</div></div>` : ''}
                        ${landDetails.land_type ? `<div class="detail-item"><div class="label">Land Type</div><div class="value">${escapeHtml(landDetails.land_type)}</div></div>` : ''}
                        ${landDetails.category ? `<div class="detail-item"><div class="label">Category</div><div class="value">${escapeHtml(landDetails.category)}</div></div>` : ''}
                        ${landDetails.assessed_value ? `<div class="detail-item"><div class="label">Land Assessed Value</div><div class="value">${landDetails.assessed_value}</div></div>` : ''}
                    </div>
                </div>
                ` : ''}

                ${photos.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Photos (${photos.length})</div>
                    <div class="photos-grid">
                        ${photos.map((p, idx) => `
                            <div class="photo-item" onclick="openLightbox(${idx})">
                                <img src="${p.url}" alt="${escapeHtml(p.description || 'Photo')}" onerror="this.style.display='none'">
                                <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${escapeHtml(p.description || p.photo_type || '')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${layouts.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Layouts / Sketches (${layouts.length})</div>
                    <div class="photos-grid">
                        ${layouts.map((l, idx) => `
                            <div class="photo-item" onclick="openLightbox(${photos.length + idx})">
                                <img src="${l.url}" alt="${escapeHtml(l.description || 'Layout')}" onerror="this.style.display='none'" style="max-width: 100%; height: auto;">
                                <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">${escapeHtml(l.description || l.layout_type || '')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${buildings.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Building Details (${buildings.length} building${buildings.length > 1 ? 's' : ''})</div>
                    ${buildings.map((bldg, idx) => `
                        <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">Building ${bldg.building_number || idx + 1}</div>
                            <div class="detail-grid" style="grid-template-columns: repeat(4, 1fr);">
                                ${bldg.year_built ? `<div class="detail-item"><div class="label">Year Built</div><div class="value">${bldg.year_built}</div></div>` : ''}
                                ${bldg.living_area_sqft ? `<div class="detail-item"><div class="label">Living Area</div><div class="value">${bldg.living_area_sqft} sqft</div></div>` : ''}
                                ${bldg.total_gross_area ? `<div class="detail-item"><div class="label">Gross Area</div><div class="value">${formatNumber(bldg.total_gross_area)} sqft</div></div>` : ''}
                                ${bldg.replacement_cost ? `<div class="detail-item"><div class="label">Replacement Cost</div><div class="value">${bldg.replacement_cost}</div></div>` : ''}
                                ${bldg.rcnld ? `<div class="detail-item"><div class="label">RCNLD</div><div class="value">${bldg.rcnld}</div></div>` : ''}
                                ${bldg.percent_good ? `<div class="detail-item"><div class="label">% Good</div><div class="value">${bldg.percent_good}%</div></div>` : ''}
                            </div>
                            ${bldg.attributes ? `
                                <div style="margin-top: 12px;">
                                    <div style="font-weight: 500; font-size: 13px; color: var(--gray-600); margin-bottom: 8px;">Building Attributes</div>
                                    <div class="detail-grid" style="grid-template-columns: repeat(4, 1fr); font-size: 13px;">
                                        ${bldg.attributes.model ? `<div class="detail-item"><div class="label">Model</div><div class="value">${bldg.attributes.model}</div></div>` : ''}
                                        ${bldg.attributes.style ? `<div class="detail-item"><div class="label">Style</div><div class="value">${bldg.attributes.style}</div></div>` : ''}
                                        ${bldg.attributes.grade ? `<div class="detail-item"><div class="label">Grade</div><div class="value">${bldg.attributes.grade}</div></div>` : ''}
                                        ${bldg.attributes.stories ? `<div class="detail-item"><div class="label">Stories</div><div class="value">${bldg.attributes.stories}</div></div>` : ''}
                                        ${bldg.attributes.occupancy ? `<div class="detail-item"><div class="label">Occupancy</div><div class="value">${bldg.attributes.occupancy}</div></div>` : ''}
                                        ${bldg.attributes.bsmt_type ? `<div class="detail-item"><div class="label">Basement</div><div class="value">${bldg.attributes.bsmt_type}</div></div>` : ''}
                                        ${bldg.attributes.fdtn_type ? `<div class="detail-item"><div class="label">Foundation</div><div class="value">${bldg.attributes.fdtn_type}</div></div>` : ''}
                                        ${bldg.attributes.roof_cover ? `<div class="detail-item"><div class="label">Roof Cover</div><div class="value">${bldg.attributes.roof_cover}</div></div>` : ''}
                                        ${bldg.attributes.exterior_wall_1 ? `<div class="detail-item"><div class="label">Exterior Wall</div><div class="value">${bldg.attributes.exterior_wall_1}</div></div>` : ''}
                                        ${bldg.attributes.interior_wall_1 ? `<div class="detail-item"><div class="label">Interior Wall</div><div class="value">${bldg.attributes.interior_wall_1}</div></div>` : ''}
                                        ${bldg.attributes.interior_flr_1 ? `<div class="detail-item"><div class="label">Interior Floor</div><div class="value">${bldg.attributes.interior_flr_1}</div></div>` : ''}
                                        ${bldg.attributes.heat_type ? `<div class="detail-item"><div class="label">Heat</div><div class="value">${bldg.attributes.heat_type}</div></div>` : ''}
                                        ${bldg.attributes.heat_fuel ? `<div class="detail-item"><div class="label">Fuel</div><div class="value">${bldg.attributes.heat_fuel}</div></div>` : ''}
                                        ${bldg.attributes.ac_type ? `<div class="detail-item"><div class="label">A/C</div><div class="value">${bldg.attributes.ac_type}</div></div>` : ''}
                                        ${bldg.attributes.total_rooms ? `<div class="detail-item"><div class="label">Rooms</div><div class="value">${bldg.attributes.total_rooms}</div></div>` : ''}
                                        ${bldg.attributes.total_bedrooms ? `<div class="detail-item"><div class="label">Bedrooms</div><div class="value">${bldg.attributes.total_bedrooms}</div></div>` : ''}
                                        ${bldg.attributes.total_full_bthrms ? `<div class="detail-item"><div class="label">Full Baths</div><div class="value">${bldg.attributes.total_full_bthrms}</div></div>` : ''}
                                        ${bldg.attributes.total_half_baths ? `<div class="detail-item"><div class="label">Half Baths</div><div class="value">${bldg.attributes.total_half_baths}</div></div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${bldg.sub_areas && bldg.sub_areas.length > 0 ? `
                                <div style="margin-top: 12px;">
                                    <div style="font-weight: 500; font-size: 13px; color: var(--gray-600); margin-bottom: 8px;">Sub-Areas</div>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                        <thead>
                                            <tr style="background: var(--gray-200);">
                                                <th style="padding: 8px; text-align: left;">Code</th>
                                                <th style="padding: 8px; text-align: left;">Description</th>
                                                <th style="padding: 8px; text-align: right;">Gross Area</th>
                                                <th style="padding: 8px; text-align: right;">Living Area</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${bldg.sub_areas.map(sa => `
                                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                                    <td style="padding: 8px;">${sa.code || 'N/A'}</td>
                                                    <td style="padding: 8px;">${escapeHtml(sa.description || 'N/A')}</td>
                                                    <td style="padding: 8px; text-align: right;">${sa.gross_area ? formatNumber(sa.gross_area) : '-'}</td>
                                                    <td style="padding: 8px; text-align: right;">${sa.living_area ? formatNumber(sa.living_area) : '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${outbuildings.length > 0 && !outbuildings[0]['No Data for Outbuildings'] ? `
                <div class="detail-section">
                    <div class="detail-section-title">Outbuildings (${outbuildings.length})</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 10px; text-align: left;">Code</th>
                                <th style="padding: 10px; text-align: left;">Description</th>
                                <th style="padding: 10px; text-align: right;">Size</th>
                                <th style="padding: 10px; text-align: right;">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${outbuildings.map(ob => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 10px;">${ob.Code || ob.code || 'N/A'}</td>
                                    <td style="padding: 10px;">${escapeHtml(ob.Description || ob.description || 'N/A')}</td>
                                    <td style="padding: 10px; text-align: right;">${ob.Size || ob.size || 'N/A'}</td>
                                    <td style="padding: 10px; text-align: right;">${ob.Value || ob.value || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                ${extraFeatures.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Extra Features (${extraFeatures.length})</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 10px; text-align: left;">Feature</th>
                                <th style="padding: 10px; text-align: left;">Description</th>
                                <th style="padding: 10px; text-align: right;">Size/Units</th>
                                <th style="padding: 10px; text-align: right;">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${extraFeatures.map(ef => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 10px;">${ef.Code || ef.Feature || ef.code || 'N/A'}</td>
                                    <td style="padding: 10px;">${escapeHtml(ef.Description || ef.description || 'N/A')}</td>
                                    <td style="padding: 10px; text-align: right;">${ef.Size || ef.Units || ef.size || 'N/A'}</td>
                                    <td style="padding: 10px; text-align: right;">${ef.Value || ef.value || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                ${exemptions.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Exemptions (${exemptions.length})</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 10px; text-align: left;">Type</th>
                                <th style="padding: 10px; text-align: left;">Description</th>
                                <th style="padding: 10px; text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${exemptions.map(ex => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 10px;">${ex.Type || ex.type || ex.Code || 'N/A'}</td>
                                    <td style="padding: 10px;">${escapeHtml(ex.Description || ex.description || 'N/A')}</td>
                                    <td style="padding: 10px; text-align: right;">${ex.Amount || ex.amount || ex.Value || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                ${valuationHistory.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Valuation History</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 10px; text-align: left;">Year</th>
                                <th style="padding: 10px; text-align: right;">Land</th>
                                <th style="padding: 10px; text-align: right;">Improvements</th>
                                <th style="padding: 10px; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${valuationHistory.map(v => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 10px; font-weight: 500;">${v['Valuation Year'] || v.valuation_year || v.year || 'N/A'}</td>
                                    <td style="padding: 10px; text-align: right;">${v.Land || v.land || 'N/A'}</td>
                                    <td style="padding: 10px; text-align: right;">${v.Improvements || v.improvements || 'N/A'}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 600;">${v.Total || v.total || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                ${salesHistory.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Sales History</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 10px; text-align: left;">Date</th>
                                <th style="padding: 10px; text-align: right;">Price</th>
                                <th style="padding: 10px; text-align: left;">Owner</th>
                                <th style="padding: 10px; text-align: left;">Book & Page</th>
                                <th style="padding: 10px; text-align: left;">Instrument</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesHistory.map(s => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 10px;">${s['Sale Date'] || s.sale_date || 'N/A'}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 500;">${s['Sale Price'] || s.sale_price || 'N/A'}</td>
                                    <td style="padding: 10px;">${escapeHtml(s.Owner || s.owner || 'N/A')}</td>
                                    <td style="padding: 10px;">${s['Book & Page'] || s.book_page || 'N/A'}</td>
                                    <td style="padding: 10px;">${s.Instrument || s.instrument || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                <!-- AI Analysis Section (loaded dynamically) -->
                <div id="aiAnalysisSection" class="ai-analysis-section" style="display: none;">
                    <div id="aiAnalysisContainer"></div>
                </div>

                <!-- Business Certificates Section (loaded dynamically) -->
                <div id="businessCertSection" style="display: none;"></div>

                <!-- Building Permits Section (loaded dynamically) -->
                <div id="buildingPermitsSection" style="display: none;"></div>

                <div class="detail-section">
                    <div class="detail-section-title">Source</div>
                    <a href="${prop.source_url}" target="_blank" style="color: var(--primary);">${prop.source_url}</a>
                    <div style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                        Scraped: ${prop.scraped_at ? new Date(prop.scraped_at).toLocaleString() : 'N/A'} |
                        Updated: ${prop.updated_at ? new Date(prop.updated_at).toLocaleString() : 'N/A'}
                    </div>
                </div>
            `;
        }

        // Load Business Certificates for a property
        async function loadBusinessCertificates(location) {
            if (!location) return;
            
            const section = document.getElementById('businessCertSection');
            if (!section) return;

            try {
                // Call the database function to find matching certificates
                const { data, error } = await db.rpc('find_business_certificates', {
                    prop_location: location
                });

                if (error) {
                    console.error('Error loading business certs:', error);
                    return;
                }

                if (data && data.length > 0) {
                    section.style.display = 'block';
                    section.innerHTML = renderBusinessCertificates(data);
                }
            } catch (e) {
                console.error('Error loading business certificates:', e);
            }
        }

        // Render Business Certificates
        function renderBusinessCertificates(certificates) {
            const activeCerts = certificates.filter(c => !c.is_expired);
            const expiredCerts = certificates.filter(c => c.is_expired);

            return `
                <div class="business-cert-section">
                    <div class="business-cert-header">
                        <span style="font-size: 20px;">🏪</span>
                        <span>Business Certificates at This Address (${certificates.length})</span>
                    </div>
                    <div class="business-cert-list">
                        ${certificates.map(cert => `
                            <div class="business-cert-item ${cert.is_expired ? 'expired' : ''}">
                                <div class="business-cert-info">
                                    <div class="business-cert-name">${escapeHtml(cert.business_name)}</div>
                                    <div class="business-cert-details">
                                        <span>📋 Cert #${cert.certificate_number || 'N/A'}</span>
                                        <span>📍 ${escapeHtml(cert.address)}</span>
                                        <span>📅 Filed: ${cert.file_date || 'N/A'}</span>
                                    </div>
                                </div>
                                <div class="business-cert-status">
                                    <span class="status-badge ${cert.is_expired ? 'expired' : 'active'}">
                                        ${cert.is_expired ? '❌ Expired' : '✓ Active'}
                                    </span>
                                    <span class="expiry-date">
                                        ${cert.is_expired ? 'Expired' : 'Expires'}: ${cert.expiration_date || 'N/A'}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${activeCerts.length > 0 ? `
                        <div style="margin-top: 12px; padding: 10px; background: #dcfce7; border-radius: 8px; font-size: 13px; color: #166534;">
                            💡 <strong>${activeCerts.length} active business${activeCerts.length > 1 ? 'es' : ''}</strong> registered at this address. 
                            Consider this when evaluating commercial potential.
                        </div>
                    ` : ''}
                    ${expiredCerts.length > 0 && activeCerts.length === 0 ? `
                        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 8px; font-size: 13px; color: #92400e;">
                            ⚠️ All ${expiredCerts.length} business certificate(s) at this address have expired.
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Load Building Permits for a property
        async function loadBuildingPermitsForProperty(acctNumber) {
            if (!acctNumber) return;

            const section = document.getElementById('buildingPermitsSection');
            if (!section) return;

            try {
                // Query by mbl field since acct_number matches MBL format in building permits
                const { data, error } = await db.from('building_permits')
                    .select('*')
                    .eq('mbl', acctNumber)
                    .order('date_submitted', { ascending: false });

                if (error) {
                    console.error('Error loading building permits:', error);
                    return;
                }

                if (data && data.length > 0) {
                    section.style.display = 'block';
                    renderBuildingPermitsSection(section, data);
                }
            } catch (e) {
                console.error('Error loading building permits:', e);
            }
        }

        // Render Building Permits Section
        function renderBuildingPermitsSection(section, permits) {
            section.textContent = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'business-cert-section';

            // Header
            const header = document.createElement('div');
            header.className = 'business-cert-header';
            header.innerHTML = '';
            const icon = document.createElement('span');
            icon.style.fontSize = '20px';
            icon.textContent = '🔨';
            header.appendChild(icon);
            const headerText = document.createElement('span');
            headerText.textContent = `Building Permits (${permits.length})`;
            header.appendChild(headerText);
            wrapper.appendChild(header);

            // List
            const list = document.createElement('div');
            list.className = 'business-cert-list';

            permits.forEach(permit => {
                const item = document.createElement('div');
                item.className = 'business-cert-item';
                if (permit.record_status?.toLowerCase().includes('denied') || permit.record_status?.toLowerCase().includes('cancel')) {
                    item.classList.add('expired');
                }

                const info = document.createElement('div');
                info.className = 'business-cert-info';

                const name = document.createElement('div');
                name.className = 'business-cert-name';
                name.textContent = permit.permit_for || permit.record_type || 'Building Permit';
                info.appendChild(name);

                const details = document.createElement('div');
                details.className = 'business-cert-details';

                const recordNum = document.createElement('span');
                recordNum.textContent = `📋 ${permit.record_number || 'N/A'}`;
                details.appendChild(recordNum);

                const addr = document.createElement('span');
                addr.textContent = `📍 ${permit.address || 'N/A'}`;
                details.appendChild(addr);

                const submitted = document.createElement('span');
                submitted.textContent = `📅 Submitted: ${permit.date_submitted ? new Date(permit.date_submitted).toLocaleDateString() : 'N/A'}`;
                details.appendChild(submitted);

                if (permit.contractor_name) {
                    const contractor = document.createElement('span');
                    contractor.textContent = `👷 ${permit.contractor_name}`;
                    details.appendChild(contractor);
                }

                info.appendChild(details);
                item.appendChild(info);

                // Status badge
                const statusWrapper = document.createElement('div');
                statusWrapper.className = 'business-cert-status';

                const badge = document.createElement('span');
                badge.className = 'status-badge';
                const status = permit.record_status?.toLowerCase() || '';
                if (status.includes('issued') || status.includes('approved') || status.includes('complete')) {
                    badge.classList.add('active');
                    badge.textContent = '✓ ' + (permit.record_status || 'Issued');
                } else if (status.includes('denied') || status.includes('rejected') || status.includes('cancel')) {
                    badge.classList.add('expired');
                    badge.textContent = '❌ ' + (permit.record_status || 'Denied');
                } else {
                    badge.style.background = '#fef3c7';
                    badge.style.color = '#92400e';
                    badge.textContent = '⏳ ' + (permit.record_status || 'Pending');
                }
                statusWrapper.appendChild(badge);

                if (permit.permit_issued_date) {
                    const issuedDate = document.createElement('span');
                    issuedDate.className = 'expiry-date';
                    issuedDate.textContent = `Issued: ${new Date(permit.permit_issued_date).toLocaleDateString()}`;
                    statusWrapper.appendChild(issuedDate);
                }

                item.appendChild(statusWrapper);
                list.appendChild(item);
            });

            wrapper.appendChild(list);

            // Summary
            const issuedCount = permits.filter(p => {
                const s = p.record_status?.toLowerCase() || '';
                return s.includes('issued') || s.includes('approved') || s.includes('complete');
            }).length;

            if (issuedCount > 0) {
                const summary = document.createElement('div');
                summary.style.cssText = 'margin-top: 12px; padding: 10px; background: #dbeafe; border-radius: 8px; font-size: 13px; color: #1e40af;';
                summary.innerHTML = '';
                const summaryText = document.createTextNode(`🔨 ${issuedCount} issued permit${issuedCount > 1 ? 's' : ''} on record for this property.`);
                summary.appendChild(summaryText);
                wrapper.appendChild(summary);
            }

            section.appendChild(wrapper);
        }

        // AI Analysis API Configuration
        const AI_API_URL = 'http://localhost:8000';  // Change to production URL when deployed

        // Store current property for AI analysis
        let currentPropertyForAI = null;

        // Check for cached AI analysis
        async function checkCachedAIAnalysis(parcelId) {
            try {
                const response = await fetch(`${AI_API_URL}/api/analysis/${parcelId}`);
                if (response.ok) {
                    const result = await response.json();
                    return result;
                }
            } catch (e) {
                console.warn('AI API not available:', e);
            }
            return { exists: false, data: null };
        }

        // Generate AI Analysis for current property
        async function generateAIAnalysis(parcelId) {
            const container = document.getElementById('aiAnalysisContainer');
            const btn = document.getElementById('aiAnalyzeBtn');

            if (!container || !btn || !currentPropertyForAI) return;

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Analyzing...';

            try {
                const response = await fetch(`${AI_API_URL}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parcel_id: parcelId,
                        address: currentPropertyForAI.location + ', Worcester, MA',
                        property_data: {
                            use_description: currentPropertyForAI.use_description,
                            zoning: currentPropertyForAI.zoning,
                            total_assessed_value: currentPropertyForAI.total_assessed_value,
                            lot_size_sqft: currentPropertyForAI.lot_size_sqft,
                            year_built: currentPropertyForAI.year_built
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Analysis failed');
                }

                const result = await response.json();
                renderAIAnalysisResults(container, result);

            } catch (e) {
                console.error('AI Analysis error:', e);
                btn.disabled = false;
                btn.innerHTML = '✨ Generate AI Analysis';
                // Show error using DOM methods (XSS safe)
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #fee2e2; border-radius: 8px; color: #991b1b; font-size: 13px;';
                errorDiv.textContent = `Failed to generate analysis. Please ensure the API server is running at ${AI_API_URL}`;
                container.appendChild(errorDiv);
            }
        }

        // AI Map instance
        let aiMapInstance = null;

        // Property Modal Map instance
        let propertyModalMapInstance = null;
        let propertyModalCoordinates = null;

        // Open Google Maps in new window
        function openGoogleMaps() {
            if (propertyModalCoordinates) {
                const { lat, lng } = propertyModalCoordinates;
                window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
            }
        }

        // Initialize Property Modal Map with geocoding
        async function initPropertyModalMap(address) {
            const mapContainer = document.getElementById('property-modal-map');
            const statusEl = document.getElementById('property-modal-map-status');
            const googleMapsBtn = document.getElementById('open-google-maps-btn');
            if (!mapContainer) return;

            // Reset state
            propertyModalCoordinates = null;
            if (googleMapsBtn) googleMapsBtn.style.display = 'none';

            // Remove existing map if any
            if (propertyModalMapInstance) {
                propertyModalMapInstance.remove();
                propertyModalMapInstance = null;
            }

            if (!address) {
                if (statusEl) statusEl.textContent = 'No address available for map';
                return;
            }

            // Show loading state
            if (statusEl) statusEl.textContent = 'Loading map...';

            try {
                // Geocode the address using Nominatim
                const searchAddress = `${address}, Worcester, MA`;
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchAddress)}&limit=1`, {
                    headers: { 'User-Agent': 'WorcesterCREDashboard/1.0' }
                });
                const results = await response.json();

                if (!results || results.length === 0) {
                    if (statusEl) statusEl.textContent = 'Could not locate address on map';
                    return;
                }

                const lat = parseFloat(results[0].lat);
                const lng = parseFloat(results[0].lon);

                // Create map
                propertyModalMapInstance = L.map('property-modal-map').setView([lat, lng], 17);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 19
                }).addTo(propertyModalMapInstance);

                // Add property marker
                const propertyIcon = L.divIcon({
                    className: 'custom-property-marker',
                    html: `<div style="background: #7c3aed; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M12 2L2 7v15h20V7L12 2zm0 2.5L19 9v10H5V9l7-4.5z"/></svg>
                    </div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                L.marker([lat, lng], { icon: propertyIcon })
                    .addTo(propertyModalMapInstance)
                    .bindPopup(`<strong>${address}</strong>`);

                // Store coordinates and show Google Maps button
                propertyModalCoordinates = { lat, lng };
                if (statusEl) statusEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                if (googleMapsBtn) googleMapsBtn.style.display = 'inline-block';

            } catch (e) {
                console.warn('Failed to load property map:', e);
                if (statusEl) statusEl.textContent = 'Failed to load map';
            }
        }

        // Initialize AI Property Map with Leaflet
        function initAIMap(coordinates, address) {
            const mapContainer = document.getElementById('ai-property-map');
            if (!mapContainer) return;

            // Remove existing map if any
            if (aiMapInstance) {
                aiMapInstance.remove();
                aiMapInstance = null;
            }

            // Create map
            aiMapInstance = L.map('ai-property-map').setView([coordinates.lat, coordinates.lng], 16);

            // Add OpenStreetMap tiles (CartoDB light theme for dashboard)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(aiMapInstance);

            // Add main property marker
            const propertyIcon = L.divIcon({
                className: 'custom-property-marker',
                html: `<div style="background: #ef4444; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 16px;">📍</span>
                </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([coordinates.lat, coordinates.lng], { icon: propertyIcon })
                .addTo(aiMapInstance)
                .bindPopup(`<strong>${address}</strong><br>Target Property`);

            // Fetch and display nearby POIs from Overpass API
            fetchNearbyPOIs(coordinates);
        }

        // Fetch nearby POIs using Overpass API
        async function fetchNearbyPOIs(coordinates) {
            if (!aiMapInstance) return;

            try {
                const query = `
                    [out:json][timeout:15];
                    (
                        node["amenity"~"restaurant|cafe|bar|bank|atm"](around:400,${coordinates.lat},${coordinates.lng});
                        node["public_transport"~"platform|station"](around:400,${coordinates.lat},${coordinates.lng});
                        node["shop"~"supermarket|convenience|mall"](around:400,${coordinates.lat},${coordinates.lng});
                    );
                    out body 15;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                if (!response.ok) return;

                const data = await response.json();
                if (!data || !data.elements) return;

                // Add POI markers
                data.elements.slice(0, 12).forEach(el => {
                    if (!el.lat || !el.lon) return;

                    const name = el.tags.name || el.tags.amenity || el.tags.shop || 'POI';
                    let color = '#64748b';
                    let emoji = '📍';

                    // Determine POI type and color
                    if (el.tags.amenity === 'restaurant' || el.tags.amenity === 'cafe' || el.tags.amenity === 'bar') {
                        color = '#f59e0b';
                        emoji = '🍽️';
                    } else if (el.tags.public_transport || el.tags.railway) {
                        color = '#3b82f6';
                        emoji = '🚇';
                    } else if (el.tags.amenity === 'bank' || el.tags.amenity === 'atm') {
                        color = '#10b981';
                        emoji = '🏦';
                    } else if (el.tags.shop) {
                        color = '#ec4899';
                        emoji = '🛒';
                    }

                    const poiIcon = L.divIcon({
                        className: 'custom-poi-marker',
                        html: `<div style="background: ${color}; padding: 4px 8px; border-radius: 12px; font-size: 11px; color: white; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            ${emoji} ${name.substring(0, 15)}${name.length > 15 ? '...' : ''}
                        </div>`,
                        iconSize: [100, 24],
                        iconAnchor: [50, 12]
                    });

                    L.marker([el.lat, el.lon], { icon: poiIcon })
                        .addTo(aiMapInstance)
                        .bindPopup(`<strong>${name}</strong>`);
                });

                // Add legend
                const legend = L.control({ position: 'bottomleft' });
                legend.onAdd = function() {
                    const div = L.DomUtil.create('div', 'ai-map-legend');
                    div.innerHTML = `
                        <div class="ai-map-legend-title">Area Highlights</div>
                        <div class="ai-map-legend-item"><span class="ai-map-legend-dot property"></span> Target Property</div>
                        <div class="ai-map-legend-item"><span class="ai-map-legend-dot food"></span> Restaurants</div>
                        <div class="ai-map-legend-item"><span class="ai-map-legend-dot transit"></span> Transit</div>
                        <div class="ai-map-legend-item"><span class="ai-map-legend-dot commercial"></span> Banks</div>
                        <div class="ai-map-legend-item"><span class="ai-map-legend-dot shop"></span> Retail</div>
                    `;
                    return div;
                };
                legend.addTo(aiMapInstance);

            } catch (e) {
                console.warn('Failed to fetch POIs:', e);
            }
        }

        // Render AI Analysis Results using safe DOM methods
        function renderAIAnalysisResults(container, data) {
            const scores = data.scores;
            const markdown = data.markdown;
            const sources = data.grounding_sources || [];
            const coordinates = data.coordinates;

            // Store data for download
            currentAIAnalysisData = data;

            // Clear container
            container.textContent = '';

            // Header
            const header = document.createElement('div');
            header.className = 'ai-analysis-header';

            const title = document.createElement('div');
            title.className = 'ai-analysis-title';
            const sparkle = document.createElement('span');
            sparkle.textContent = '✨';
            title.appendChild(sparkle);
            const titleText = document.createElement('span');
            titleText.textContent = 'AI Property Analysis';
            title.appendChild(titleText);
            header.appendChild(title);

            // Header actions (cached badge + download button)
            const headerActions = document.createElement('div');
            headerActions.className = 'ai-header-actions';

            if (data.cached) {
                const badge = document.createElement('span');
                badge.className = 'ai-cached-badge';
                badge.textContent = '✓ Cached';
                headerActions.appendChild(badge);
            }

            // Download button
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'ai-download-btn';
            downloadBtn.innerHTML = '<svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download Report';
            downloadBtn.onclick = downloadAIReport;
            headerActions.appendChild(downloadBtn);

            header.appendChild(headerActions);
            container.appendChild(header);

            // Map section (if coordinates available)
            if (coordinates && coordinates.lat && coordinates.lng) {
                const mapSection = document.createElement('div');
                mapSection.style.marginBottom = '20px';

                // Map header
                const mapHeader = document.createElement('div');
                mapHeader.className = 'ai-map-header';

                const mapTitle = document.createElement('div');
                mapTitle.className = 'ai-map-title';
                mapTitle.innerHTML = '📍 Neighborhood Intelligence';
                mapHeader.appendChild(mapTitle);

                const mapLink = document.createElement('a');
                mapLink.href = `https://www.google.com/maps/search/?api=1&query=${coordinates.lat},${coordinates.lng}`;
                mapLink.target = '_blank';
                mapLink.className = 'ai-map-link';
                mapLink.textContent = 'Open in Google Maps →';
                mapHeader.appendChild(mapLink);

                mapSection.appendChild(mapHeader);

                // Map container
                const mapContainer = document.createElement('div');
                mapContainer.id = 'ai-property-map';
                mapContainer.className = 'ai-map-container';
                mapSection.appendChild(mapContainer);

                container.appendChild(mapSection);

                // Initialize map after DOM is ready
                setTimeout(() => {
                    initAIMap(coordinates, currentPropertyForAI?.location || 'Property');
                }, 100);
            }

            // Scores section
            if (scores) {
                const scoresContainer = document.createElement('div');
                scoresContainer.className = 'ai-scores-container';

                // Radar chart
                const chartDiv = document.createElement('div');
                chartDiv.className = 'ai-radar-chart';
                chartDiv.innerHTML = renderRadarChart(scores);  // SVG is safe
                scoresContainer.appendChild(chartDiv);

                // Scores list
                const scoresList = document.createElement('div');
                scoresList.className = 'ai-scores-list';

                const scoreItems = [
                    { label: 'Walkability', key: 'walkability', value: scores.walkability },
                    { label: 'Transit Access', key: 'transit', value: scores.transit },
                    { label: 'Market Stability', key: 'market-stability', value: scores.market_stability },
                    { label: 'Future Growth', key: 'future-growth', value: scores.future_growth },
                    { label: 'Amenity Density', key: 'amenity-density', value: scores.amenity_density }
                ];

                scoreItems.forEach(item => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'ai-score-item';

                    const label = document.createElement('div');
                    label.className = 'ai-score-label';
                    label.textContent = item.label;
                    scoreItem.appendChild(label);

                    const bar = document.createElement('div');
                    bar.className = 'ai-score-bar';
                    const fill = document.createElement('div');
                    fill.className = `ai-score-fill ${item.key}`;
                    fill.style.width = `${item.value}%`;
                    bar.appendChild(fill);
                    scoreItem.appendChild(bar);

                    const valueEl = document.createElement('div');
                    valueEl.className = 'ai-score-value';
                    valueEl.textContent = item.value;
                    scoreItem.appendChild(valueEl);

                    scoresList.appendChild(scoreItem);
                });

                scoresContainer.appendChild(scoresList);
                container.appendChild(scoresContainer);
            }

            // Markdown content
            const markdownContainer = document.createElement('div');
            markdownContainer.className = 'ai-markdown-container';
            markdownContainer.innerHTML = parseMarkdown(markdown);  // Parsed markdown from our API
            container.appendChild(markdownContainer);

            // Sources
            if (sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'ai-sources';

                const sourcesTitle = document.createElement('div');
                sourcesTitle.className = 'ai-sources-title';
                sourcesTitle.textContent = 'Sources';
                sourcesDiv.appendChild(sourcesTitle);

                const sourcesList = document.createElement('div');
                sourcesList.className = 'ai-sources-list';

                sources.forEach(s => {
                    const link = document.createElement('a');
                    link.href = s.uri;
                    link.target = '_blank';
                    link.className = 'ai-source-link';
                    link.textContent = s.title || 'Source';
                    sourcesList.appendChild(link);
                });

                sourcesDiv.appendChild(sourcesList);
                container.appendChild(sourcesDiv);
            }
        }

        // Store AI analysis data for download
        let currentAIAnalysisData = null;

        // Download AI Analysis Report as PDF - captures exactly what's displayed
        async function downloadAIReport() {
            if (!currentAIAnalysisData || !currentPropertyForAI) {
                alert('No analysis data available to download.');
                return;
            }

            const btn = document.querySelector('.ai-download-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Generating...';
            }

            try {
                const prop = currentPropertyForAI;

                // Helper function to convert an image URL to base64 via CORS proxy
                async function imageUrlToBase64(url) {
                    // Try multiple CORS proxies as fallbacks
                    const corsProxies = [
                        (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                        (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                        (u) => u // Try direct as last resort
                    ];

                    for (const proxyFn of corsProxies) {
                        try {
                            const proxyUrl = proxyFn(url);
                            console.log('Trying to fetch image via:', proxyUrl);
                            const response = await fetch(proxyUrl);
                            if (!response.ok) continue;
                            const blob = await response.blob();
                            return new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(blob);
                            });
                        } catch (e) {
                            console.warn('Proxy failed:', proxyFn.toString(), e);
                            continue;
                        }
                    }
                    console.warn('All proxies failed for:', url);
                    return null;
                }

                // Helper function to convert all images in a section to base64
                async function convertSectionImagesToBase64(section) {
                    const images = section.querySelectorAll('img');
                    const originalSrcs = [];
                    for (const img of images) {
                        originalSrcs.push(img.src);
                        if (img.src && !img.src.startsWith('data:')) {
                            const base64 = await imageUrlToBase64(img.src);
                            if (base64) {
                                img.src = base64;
                            }
                        }
                    }
                    return originalSrcs;
                }

                // Helper function to restore original image sources
                function restoreImageSources(section, originalSrcs) {
                    const images = section.querySelectorAll('img');
                    images.forEach((img, idx) => {
                        if (originalSrcs[idx]) {
                            img.src = originalSrcs[idx];
                        }
                    });
                }

                // Skip html2canvas - directly build photos/layouts from property data for better control
                let photosCanvasData = null;
                let layoutsCanvasData = null;

                // Get the actual displayed AI analysis container
                const analysisContainer = document.getElementById('aiAnalysisContainer');
                if (!analysisContainer) {
                    throw new Error('Analysis container not found');
                }

                // Temporarily hide the download button
                if (btn) btn.style.display = 'none';

                // Add a temporary header before the container
                const header = document.createElement('div');
                header.id = 'pdf-temp-header';
                header.style.cssText = 'background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;';
                header.innerHTML = `
                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 6px;">
                        AI Property Analysis Report • ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                    </div>
                    <h1 style="font-size: 22px; font-weight: 700; margin: 0;">${escapeHtml(prop.location || 'Property Report')}</h1>
                    <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Parcel ID: ${escapeHtml(prop.parcel_id || 'N/A')}</div>
                `;
                analysisContainer.insertBefore(header, analysisContainer.firstChild);

                // Add photos section - try captured version first, fallback to direct images
                let photosSection = null;
                const photos = prop.photos || [];
                const layouts = prop.layouts || [];

                if (photosCanvasData) {
                    photosSection = document.createElement('div');
                    photosSection.id = 'pdf-temp-photos';
                    photosSection.style.cssText = 'margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;';
                    const photoImg = document.createElement('img');
                    photoImg.src = photosCanvasData;
                    photoImg.alt = 'Property Photos';
                    photoImg.style.cssText = 'width: 100%; height: auto; border-radius: 8px;';
                    photosSection.appendChild(photoImg);
                    analysisContainer.appendChild(photosSection);
                } else if (photos.length > 0) {
                    // Fallback: Build photos section directly from property data with base64 images
                    console.log('Using fallback method for photos - converting individually');
                    photosSection = document.createElement('div');
                    photosSection.id = 'pdf-temp-photos';
                    photosSection.style.cssText = 'margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;';

                    const photosTitle = document.createElement('div');
                    photosTitle.style.cssText = 'font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #3b82f6;';
                    photosTitle.textContent = `Photos (${photos.length})`;
                    photosSection.appendChild(photosTitle);

                    const photosGrid = document.createElement('div');
                    photosGrid.style.cssText = 'display: grid; grid-template-columns: 1fr; gap: 16px;';

                    for (const photo of photos) {
                        const base64 = await imageUrlToBase64(photo.url);
                        if (base64) {
                            const photoDiv = document.createElement('div');
                            photoDiv.style.cssText = 'text-align: center;';
                            const img = document.createElement('img');
                            img.src = base64;
                            img.alt = photo.description || 'Photo';
                            img.style.cssText = 'width: 100%; max-width: 500px; height: auto; border-radius: 8px; border: 1px solid #e2e8f0;';
                            photoDiv.appendChild(img);
                            const caption = document.createElement('div');
                            caption.style.cssText = 'font-size: 11px; color: #6b7280; margin-top: 4px;';
                            caption.textContent = photo.description || photo.photo_type || '';
                            photoDiv.appendChild(caption);
                            photosGrid.appendChild(photoDiv);
                        }
                    }
                    photosSection.appendChild(photosGrid);
                    analysisContainer.appendChild(photosSection);
                }

                // Add layouts section - try captured version first, fallback to direct images
                let layoutsSection = null;
                if (layoutsCanvasData) {
                    layoutsSection = document.createElement('div');
                    layoutsSection.id = 'pdf-temp-layouts';
                    layoutsSection.style.cssText = 'margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;';
                    const layoutImg = document.createElement('img');
                    layoutImg.src = layoutsCanvasData;
                    layoutImg.alt = 'Building Layouts';
                    layoutImg.style.cssText = 'width: 100%; height: auto; border-radius: 8px;';
                    layoutsSection.appendChild(layoutImg);
                    analysisContainer.appendChild(layoutsSection);
                } else if (layouts.length > 0) {
                    // Fallback: Build layouts section directly from property data with base64 images
                    console.log('Using fallback method for layouts - converting individually');
                    layoutsSection = document.createElement('div');
                    layoutsSection.id = 'pdf-temp-layouts';
                    layoutsSection.style.cssText = 'margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;';

                    const layoutsTitle = document.createElement('div');
                    layoutsTitle.style.cssText = 'font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #3b82f6;';
                    layoutsTitle.textContent = `Layouts / Sketches (${layouts.length})`;
                    layoutsSection.appendChild(layoutsTitle);

                    const layoutsGrid = document.createElement('div');
                    layoutsGrid.style.cssText = 'display: grid; grid-template-columns: 1fr; gap: 16px;';

                    for (const layout of layouts) {
                        const base64 = await imageUrlToBase64(layout.url);
                        if (base64) {
                            const layoutDiv = document.createElement('div');
                            layoutDiv.style.cssText = 'text-align: center;';
                            const img = document.createElement('img');
                            img.src = base64;
                            img.alt = layout.description || 'Layout';
                            img.style.cssText = 'width: 100%; max-width: 500px; height: auto; border-radius: 8px; border: 1px solid #e2e8f0;';
                            layoutDiv.appendChild(img);
                            const caption = document.createElement('div');
                            caption.style.cssText = 'font-size: 11px; color: #6b7280; margin-top: 4px;';
                            caption.textContent = layout.description || layout.layout_type || '';
                            layoutDiv.appendChild(caption);
                            layoutsGrid.appendChild(layoutDiv);
                        }
                    }
                    layoutsSection.appendChild(layoutsGrid);
                    analysisContainer.appendChild(layoutsSection);
                }

                // Wait for images to load
                await new Promise(resolve => setTimeout(resolve, 800));

                // PDF options
                const opt = {
                    margin: [15, 15, 15, 15],
                    filename: `${(prop.location || 'Property').replace(/[^a-zA-Z0-9\s]/g, '').trim()} Analysis.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], avoid: ['img', 'tr', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'] }
                };

                // Capture the actual visible container
                await html2pdf().set(opt).from(analysisContainer).save();

                // Cleanup - remove temp elements and restore button
                header.remove();
                if (photosSection) photosSection.remove();
                if (layoutsSection) layoutsSection.remove();
                if (btn) btn.style.display = '';

            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate report. Please try again.');
                // Cleanup on error
                const tempHeader = document.getElementById('pdf-temp-header');
                if (tempHeader) tempHeader.remove();
                const tempPhotos = document.getElementById('pdf-temp-photos');
                if (tempPhotos) tempPhotos.remove();
                const tempLayouts = document.getElementById('pdf-temp-layouts');
                if (tempLayouts) tempLayouts.remove();
            } finally {
                if (btn) {
                    btn.style.display = '';
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download Report';
                }
            }
        }

        // Generate Beautiful Report HTML
        function generateReportHTML(prop, data, scores, coordinates, mapImage) {
            const address = prop.location || 'Property Address';
            const parcelId = prop.parcel_id || 'N/A';
            const owner = prop.owner_name || 'N/A';
            const zoning = prop.zoning || 'N/A';
            const assessedValue = prop.assessed_value ? '$' + Number(prop.assessed_value).toLocaleString() : 'N/A';
            const markdown = data.markdown || '';
            const sources = data.grounding_sources || [];

            // Calculate overall score
            const overallScore = scores ? Math.round(
                (scores.walkability + scores.transit + scores.market_stability +
                 scores.future_growth + scores.amenity_density) / 5
            ) : 'N/A';

            // Score color function
            const getScoreColor = (score) => {
                if (score >= 80) return '#22c55e';
                if (score >= 60) return '#3b82f6';
                if (score >= 40) return '#f59e0b';
                return '#ef4444';
            };

            return `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; color: #1f2937; line-height: 1.5;">

                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 6px;">AI Property Analysis Report • ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        <h1 style="font-size: 20px; font-weight: 700; margin: 0 0 6px 0;">${escapeHtml(address)}</h1>
                        <div style="font-size: 12px; opacity: 0.9;">Parcel ID: ${escapeHtml(parcelId)}</div>
                    </div>

                    <!-- Property Quick Facts -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div style="flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">Owner</div>
                            <div style="font-size: 11px; font-weight: 600; color: #1e293b;">${escapeHtml(owner)}</div>
                        </div>
                        <div style="flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">Zoning</div>
                            <div style="font-size: 11px; font-weight: 600; color: #1e293b;">${escapeHtml(zoning)}</div>
                        </div>
                        <div style="flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">Value</div>
                            <div style="font-size: 11px; font-weight: 600; color: #1e293b;">${escapeHtml(assessedValue)}</div>
                        </div>
                        <div style="flex: 1; background: linear-gradient(135deg, ${getScoreColor(overallScore)} 0%, ${getScoreColor(overallScore)}dd 100%); border-radius: 6px; padding: 12px; text-align: center; color: white;">
                            <div style="font-size: 9px; text-transform: uppercase; margin-bottom: 4px; opacity: 0.9;">Score</div>
                            <div style="font-size: 20px; font-weight: 700;">${overallScore}</div>
                        </div>
                    </div>

                    ${mapImage ? `
                    <!-- Map Section -->
                    <div style="margin-bottom: 20px;" class="keep-together">
                        <h2 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 10px;">📍 Location & Neighborhood</h2>
                        <div style="border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
                            <img src="${mapImage}" style="width: 100%; height: auto; display: block;" alt="Property Map"/>
                        </div>
                        ${coordinates ? `
                        <div style="font-size: 11px; color: #64748b; margin-top: 6px; text-align: center;">
                            Coordinates: ${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    ${scores ? `
                    <!-- Scores Section -->
                    <div style="margin-bottom: 20px;" class="keep-together">
                        <h2 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">📊 Property Scores</h2>
                        <div style="display: flex; gap: 10px;">
                            ${generateScoreCard('Walkability', scores.walkability, '#22c55e')}
                            ${generateScoreCard('Transit', scores.transit, '#3b82f6')}
                            ${generateScoreCard('Market', scores.market_stability, '#f59e0b')}
                            ${generateScoreCard('Growth', scores.future_growth, '#8b5cf6')}
                            ${generateScoreCard('Amenity', scores.amenity_density, '#ec4899')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Analysis Section -->
                    <div style="margin-bottom: 20px;">
                        <h2 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">📝 Detailed Analysis</h2>
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                            <div style="font-size: 12px; color: #374151; line-height: 1.6;">
                                ${parseMarkdownForReport(markdown)}
                            </div>
                        </div>
                    </div>

                    ${sources.length > 0 ? `
                    <!-- Sources Section -->
                    <div style="margin-bottom: 20px;" class="keep-together">
                        <h2 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 10px;">🔗 Data Sources</h2>
                        <div style="background: #f1f5f9; border-radius: 6px; padding: 12px;">
                            ${sources.slice(0, 6).map(s => `
                                <div style="font-size: 10px; color: #475569; margin-bottom: 5px;">
                                    • ${escapeHtml(s.title || s.uri?.split('/')[2] || 'Source')}
                                </div>
                            `).join('')}
                            ${sources.length > 6 ? `<div style="font-size: 10px; color: #94a3b8; margin-top: 6px;">+${sources.length - 6} more sources</div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Footer -->
                    <div style="border-top: 1px solid #e2e8f0; padding-top: 16px; margin-top: 24px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8;">
                            Generated by Worcester CRE Dashboard • Powered by Gemini AI
                        </div>
                        <div style="font-size: 10px; color: #cbd5e1; margin-top: 4px;">
                            This report is for informational purposes only. Verify all data before making investment decisions.
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate score card HTML for report
        function generateScoreCard(label, score, color) {
            const percentage = score || 0;
            return `
                <div style="flex: 1; background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; text-align: center;">
                    <div style="font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">${label}</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${color};">${percentage}</div>
                </div>
            `;
        }

        // Parse markdown for report (simplified, returns HTML)
        function parseMarkdownForReport(text) {
            if (!text) return '<p>No analysis available.</p>';

            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/^### (.*$)/gm, '<h4 style="font-size: 12px; font-weight: 600; color: #1e293b; margin: 14px 0 6px 0;">$1</h4>')
                .replace(/^## (.*$)/gm, '<h3 style="font-size: 13px; font-weight: 700; color: #7c3aed; margin: 16px 0 8px 0;">$1</h3>')
                .replace(/^# (.*$)/gm, '<h2 style="font-size: 14px; font-weight: 700; color: #1e293b; margin: 18px 0 10px 0;">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^\- (.*$)/gm, '<div class="keep-together" style="margin: 4px 0 4px 16px;">• $1</div>')
                .replace(/^\* (.*$)/gm, '<div class="keep-together" style="margin: 4px 0 4px 16px;">• $1</div>')
                .replace(/\n\n/g, '</p><p style="margin: 10px 0;">')
                .replace(/\n/g, '<br>');
        }

        // Escape HTML for safe rendering
        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Simple Markdown Parser (returns sanitized HTML)
        function parseMarkdown(text) {
            if (!text) return '';

            // Escape HTML first to prevent XSS
            let escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            return escaped
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Lists
                .replace(/^\- (.*$)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                // Clean up
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-3]>)/g, '$1')
                .replace(/(<\/h[1-3]>)<\/p>/g, '$1')
                .replace(/<p>(<ul>)/g, '$1')
                .replace(/(<\/ul>)<\/p>/g, '$1')
                .replace(/<p>(<li>)/g, '$1')
                .replace(/(<\/li>)<\/p>/g, '$1');
        }

        // Render SVG Radar Chart (returns safe SVG string)
        function renderRadarChart(scores) {
            const size = 200;
            const center = size / 2;
            const radius = 80;

            // Score values normalized to 0-1
            const values = [
                scores.walkability / 100,
                scores.transit / 100,
                scores.market_stability / 100,
                scores.future_growth / 100,
                scores.amenity_density / 100
            ];

            const labels = ['Walk', 'Transit', 'Stability', 'Growth', 'Amenity'];
            const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];

            // Calculate points for pentagon
            const angleStep = (Math.PI * 2) / 5;
            const startAngle = -Math.PI / 2; // Start from top

            // Generate grid circles
            let gridCircles = '';
            for (let r = 0.2; r <= 1; r += 0.2) {
                const circleRadius = radius * r;
                gridCircles += `<circle cx="${center}" cy="${center}" r="${circleRadius}" fill="none" stroke="#e5e7eb" stroke-width="1"/>`;
            }

            // Generate axis lines and labels
            let axes = '';
            for (let i = 0; i < 5; i++) {
                const angle = startAngle + (i * angleStep);
                const x = center + Math.cos(angle) * radius;
                const y = center + Math.sin(angle) * radius;
                const labelX = center + Math.cos(angle) * (radius + 15);
                const labelY = center + Math.sin(angle) * (radius + 15);

                axes += `<line x1="${center}" y1="${center}" x2="${x}" y2="${y}" stroke="#d1d5db" stroke-width="1"/>`;
                axes += `<text x="${labelX}" y="${labelY}" text-anchor="middle" dominant-baseline="middle" fill="#6b7280" font-size="10" font-weight="500">${labels[i]}</text>`;
            }

            // Generate data polygon
            let dataPoints = '';
            for (let i = 0; i < 5; i++) {
                const angle = startAngle + (i * angleStep);
                const r = radius * values[i];
                const x = center + Math.cos(angle) * r;
                const y = center + Math.sin(angle) * r;
                dataPoints += `${x},${y} `;
            }

            // Generate score dots
            let dots = '';
            for (let i = 0; i < 5; i++) {
                const angle = startAngle + (i * angleStep);
                const r = radius * values[i];
                const x = center + Math.cos(angle) * r;
                const y = center + Math.sin(angle) * r;
                dots += `<circle cx="${x}" cy="${y}" r="4" fill="${colors[i]}" stroke="white" stroke-width="2"/>`;
            }

            return `
                <svg viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">
                    ${gridCircles}
                    ${axes}
                    <polygon points="${dataPoints}" fill="rgba(139, 92, 246, 0.2)" stroke="#8b5cf6" stroke-width="2"/>
                    ${dots}
                </svg>
            `;
        }

        // Load AI Analysis section (called when modal opens)
        async function loadAIAnalysisSection(prop) {
            currentPropertyForAI = prop;
            const section = document.getElementById('aiAnalysisSection');
            if (!section) return;

            section.style.display = 'block';

            // Check for cached analysis
            const cached = await checkCachedAIAnalysis(prop.parcel_id);

            const container = document.getElementById('aiAnalysisContainer');
            if (!container) return;

            container.textContent = '';

            if (cached.exists && cached.data) {
                renderAIAnalysisResults(container, cached.data);
            } else {
                // Create button using DOM methods
                const btn = document.createElement('button');
                btn.id = 'aiAnalyzeBtn';
                btn.className = 'ai-analyze-btn';
                btn.textContent = '✨ Generate AI Analysis';
                btn.onclick = () => generateAIAnalysis(prop.parcel_id);
                container.appendChild(btn);

                const subtitle = document.createElement('div');
                subtitle.className = 'ai-analyze-subtitle';
                subtitle.textContent = 'Get walkability, transit, and market insights powered by AI';
                container.appendChild(subtitle);
            }
        }

        // Close Modal
        function closeModal() {
            document.getElementById('propertyModal').classList.remove('active');
            // Return to previous view if modal was opened from a different tab
            if (previousView && previousView !== currentView) {
                switchView(previousView);
                previousView = null;
            }
        }

        // Close Lead Panel (mobile)
        function closeLeadPanel() {
            document.getElementById('leadPanel').classList.remove('mobile-visible');
        }

        // Set Filter
        function setFilter(filter) {
            currentFilter = filter;
            currentPage = 1;
            
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });
            
            loadProperties();
        }

        // View Mode Toggle
        function setViewMode(mode) {
            viewMode = mode;
            
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });
            
            // Show/hide containers
            document.getElementById('propertyList').style.display = mode === 'cards' ? 'block' : 'none';
            document.getElementById('propertyTableContainer').style.display = mode === 'table' ? 'block' : 'none';
            
            // Re-render
            renderProperties(currentProperties);
        }

        // Property Type Filter
        function setPropertyTypeFilter(type) {
            propertyTypeFilter = type;
            currentPage = 1;
            loadProperties();
        }

        // Sort Column
        function setSortColumn(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                sortColumn = column;
                // Default direction based on column type
                sortDirection = ['total_assessed_value', 'ownership_years', 'year_built'].includes(column) ? 'desc' : 'asc';
            }
            currentPage = 1;
            loadProperties();
        }

        // Handle column header click for sorting
        function handleColumnSort(column) {
            setSortColumn(column);
            document.getElementById('sortDropdown').value = column;
        }

        // Update sort indicators on table headers
        function updateSortIndicators() {
            document.querySelectorAll('.property-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === sortColumn) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Selection Functions
        function togglePropertySelection(parcelId, isChecked) {
            if (isChecked) {
                selectedProperties.add(parcelId);
            } else {
                selectedProperties.delete(parcelId);
            }
            updateSelectionUI();
        }

        function selectAll() {
            currentProperties.forEach(prop => selectedProperties.add(prop.parcel_id));
            renderProperties(currentProperties);
            updateSelectionUI();
        }

        function deselectAll() {
            selectedProperties.clear();
            renderProperties(currentProperties);
            updateSelectionUI();
        }

        function toggleSelectAll(checkbox) {
            if (checkbox.checked) {
                selectAll();
            } else {
                deselectAll();
            }
        }

        function updateSelectionUI() {
            const count = selectedProperties.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('exportCount').textContent = count;
            document.getElementById('exportBtn').disabled = count === 0;
            
            // Update "select all" checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = currentProperties.length > 0 && 
                    currentProperties.every(p => selectedProperties.has(p.parcel_id));
            }
        }

        // CSV Export
        async function exportSelectedToCSV() {
            if (selectedProperties.size === 0) {
                showToast('Please select at least one property to export.', 'error');
                return;
            }

            showToast('Preparing export...', 'info');

            try {
                // Fetch full data for selected properties
                const parcelIds = Array.from(selectedProperties);
                const { data: properties, error } = await db
                    .from('worcester_data_collection')
                    .select('*')
                    .in('parcel_id', parcelIds);

                if (error) throw error;

                // CSV Headers
                const headers = [
                    'Parcel ID', 'Address', 'Owner Name', 'Co-Owner', 'Mailing Address',
                    'Assessed Value', 'Land Value', 'Improvements Value', 'Tax Amount',
                    'Ownership Years', 'Last Sale Date', 'Last Sale Price',
                    'Year Built', 'Living Area SqFt', 'Lot Size SqFt',
                    'Bedrooms', 'Bathrooms', 'Building Style', 'Use Description',
                    'Zoning', 'Neighborhood',
                    'Lead Status', 'Lead Priority', 'Lead Notes', 'Follow Up Date',
                    'Contact Name', 'Contact Phone', 'Contact Email'
                ];

                // Build CSV rows
                const rows = properties.map(prop => {
                    const lead = leadsCache[prop.parcel_id] || {};
                    
                    return [
                        prop.parcel_id || '',
                        prop.location || '',
                        prop.owner_name || '',
                        prop.co_owner || '',
                        prop.owner_mailing_address || '',
                        prop.total_assessed_value || '',
                        prop.land_value || '',
                        prop.improvements_value || '',
                        prop.tax_amount || '',
                        prop.ownership_years || '',
                        prop.last_sale_date || '',
                        prop.last_sale_price || '',
                        prop.year_built || '',
                        prop.living_area_sqft || '',
                        prop.lot_size_sqft || '',
                        prop.bedrooms || '',
                        prop.bathrooms || '',
                        prop.building_style || '',
                        prop.use_description || '',
                        prop.zoning || '',
                        prop.neighborhood || '',
                        lead.status || 'new',
                        lead.priority || '',
                        (lead.notes || '').replace(/,/g, ';').replace(/\n/g, ' '),
                        lead.follow_up_date || '',
                        lead.contact_name || '',
                        lead.contact_phone || '',
                        lead.contact_email || ''
                    ];
                });

                // Create CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // Download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `worcester_properties_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast(`Exported ${properties.length} properties to CSV`, 'success');
            } catch (e) {
                console.error('Error exporting CSV:', e);
                showToast('Error exporting CSV: ' + e.message, 'error');
            }
        }

        // ===== ENHANCED SEARCH FUNCTIONS =====

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            advancedFilters = {};
            document.getElementById('searchClear').classList.remove('visible');
            document.getElementById('searchResultsInfo').classList.remove('visible');
            currentPage = 1;
            hideSearchSuggestions();
            loadProperties();
        }

        // Show search suggestions dropdown
        function showSearchSuggestions(query) {
            const container = document.getElementById('searchSuggestions');
            const resultsDiv = document.getElementById('searchResults');
            
            // Show live search results
            searchPropertiesLive(query).then(results => {
                if (results.length > 0) {
                    resultsDiv.innerHTML = `
                        <div class="search-suggestion-title">Matching Properties (${results.length})</div>
                        ${results.slice(0, 5).map(prop => `
                            <div class="search-suggestion-item" onclick="selectSearchResult('${prop.parcel_id}')">
                                <span class="search-suggestion-icon">🏠</span>
                                <span class="search-suggestion-text">
                                    <div class="search-suggestion-main">${highlightMatch(prop.location || 'N/A', query)}</div>
                                    <div class="search-suggestion-sub">${highlightMatch(prop.owner_name || '', query)} • ${prop.total_assessed_value ? '$' + formatNumber(prop.total_assessed_value) : 'N/A'}</div>
                                </span>
                            </div>
                        `).join('')}
                        ${results.length > 5 ? `<div class="search-suggestion-item" onclick="hideSearchSuggestions(); loadProperties();"><span class="search-suggestion-icon">➡️</span><span class="search-suggestion-text"><div class="search-suggestion-main">View all ${results.length} results...</div></span></div>` : ''}
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="search-suggestion-title">No matching properties found</div>`;
                }
            });
            
            container.classList.add('visible');
            document.getElementById('recentSearches').style.display = 'none';
            document.getElementById('quickSearches').style.display = 'none';
        }

        // Search properties live for suggestions
        async function searchPropertiesLive(query) {
            try {
                const { data, error } = await db
                    .from('worcester_data_collection')
                    .select('parcel_id, location, owner_name, total_assessed_value')
                    .or(`location.ilike.%${query}%,owner_name.ilike.%${query}%,parcel_id.ilike.%${query}%,neighborhood.ilike.%${query}%`)
                    .limit(20);
                
                return data || [];
            } catch (e) {
                console.error('Error searching:', e);
                return [];
            }
        }

        // Highlight matching text
        function highlightMatch(text, query) {
            if (!text || !query) return escapeHtml(text || '');
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escapeHtml(text).replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Select search result and show property
        function selectSearchResult(parcelId) {
            hideSearchSuggestions();
            searchQuery = '';
            document.getElementById('searchInput').value = '';
            selectProperty(parcelId);
            openPropertyModal(parcelId);
        }

        // Show recent searches
        function showRecentSearches() {
            const container = document.getElementById('searchSuggestions');
            const recentDiv = document.getElementById('recentSearches');
            
            if (recentSearches.length > 0) {
                recentDiv.innerHTML = `
                    <div class="search-suggestion-title">Recent Searches</div>
                    ${recentSearches.slice(0, 5).map((search, idx) => `
                        <div class="recent-search-item" onclick="applyRecentSearch('${escapeHtml(search)}')">
                            <span>🕒</span>
                            <span>${escapeHtml(search)}</span>
                            <span class="recent-search-delete" onclick="event.stopPropagation(); deleteRecentSearch(${idx})">✕</span>
                        </div>
                    `).join('')}
                `;
                recentDiv.style.display = 'block';
            } else {
                recentDiv.style.display = 'none';
            }
            
            document.getElementById('quickSearches').style.display = 'block';
            document.getElementById('searchResults').innerHTML = '';
            container.classList.add('visible');
        }

        // Save recent search
        function saveRecentSearch(query) {
            if (!query || query.length < 2) return;
            recentSearches = recentSearches.filter(s => s.toLowerCase() !== query.toLowerCase());
            recentSearches.unshift(query);
            recentSearches = recentSearches.slice(0, 10);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }

        // Apply recent search
        function applyRecentSearch(query) {
            document.getElementById('searchInput').value = query;
            searchQuery = query;
            document.getElementById('searchClear').classList.add('visible');
            hideSearchSuggestions();
            currentPage = 1;
            loadProperties();
            updateSearchResultsInfo();
        }

        // Delete recent search
        function deleteRecentSearch(idx) {
            recentSearches.splice(idx, 1);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            showRecentSearches();
        }

        // Hide search suggestions
        function hideSearchSuggestions() {
            document.getElementById('searchSuggestions').classList.remove('visible');
        }

        // Apply quick search
        function applyQuickSearch(type, value) {
            hideSearchSuggestions();
            advancedFilters = {};
            
            switch(type) {
                case 'value':
                    advancedFilters.minValue = parseInt(value);
                    showToast('Showing properties over $' + formatNumber(value), 'success');
                    break;
                case 'ownership':
                    advancedFilters.minOwnership = parseInt(value);
                    showToast('Showing properties owned ' + value + '+ years', 'success');
                    break;
                case 'type':
                    propertyTypeFilter = value;
                    document.getElementById('propertyTypeFilter').value = value;
                    showToast('Showing ' + value + ' properties', 'success');
                    break;
            }
            
            currentPage = 1;
            loadProperties();
            updateSearchResultsInfo();
        }

        // Update search results info
        function updateSearchResultsInfo() {
            const infoDiv = document.getElementById('searchResultsInfo');
            const hasFilters = searchQuery || Object.keys(advancedFilters).length > 0 || propertyTypeFilter !== 'all';
            
            if (hasFilters) {
                let filterText = [];
                if (searchQuery) filterText.push(`"${searchQuery}"`);
                if (advancedFilters.minValue) filterText.push(`Value ≥ $${formatNumber(advancedFilters.minValue)}`);
                if (advancedFilters.maxValue) filterText.push(`Value ≤ $${formatNumber(advancedFilters.maxValue)}`);
                if (advancedFilters.minOwnership) filterText.push(`Ownership ≥ ${advancedFilters.minOwnership} yrs`);
                if (advancedFilters.maxOwnership) filterText.push(`Ownership ≤ ${advancedFilters.maxOwnership} yrs`);
                if (advancedFilters.address) filterText.push(`Address: "${advancedFilters.address}"`);
                if (advancedFilters.owner) filterText.push(`Owner: "${advancedFilters.owner}"`);
                if (propertyTypeFilter !== 'all') filterText.push(`Type: ${propertyTypeFilter}`);
                
                infoDiv.innerHTML = `🔍 Filters: ${filterText.join(' • ')} <button onclick="clearSearch()" style="margin-left: 8px; background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline;">Clear all</button>`;
                infoDiv.classList.add('visible');
            } else {
                infoDiv.classList.remove('visible');
            }
        }

        // Open Advanced Search Modal
        function openAdvancedSearch() {
            document.getElementById('advancedSearchModal').classList.add('active');
            hideSearchSuggestions();
            
            // Populate with current filters
            if (advancedFilters.address) document.getElementById('advAddress').value = advancedFilters.address;
            if (advancedFilters.owner) document.getElementById('advOwner').value = advancedFilters.owner;
            if (advancedFilters.parcelId) document.getElementById('advParcelId').value = advancedFilters.parcelId;
            if (advancedFilters.minValue) document.getElementById('advMinValue').value = advancedFilters.minValue;
            if (advancedFilters.maxValue) document.getElementById('advMaxValue').value = advancedFilters.maxValue;
            if (advancedFilters.minOwnership) document.getElementById('advMinOwnership').value = advancedFilters.minOwnership;
            if (advancedFilters.maxOwnership) document.getElementById('advMaxOwnership').value = advancedFilters.maxOwnership;
            if (advancedFilters.minYearBuilt) document.getElementById('advMinYearBuilt').value = advancedFilters.minYearBuilt;
            if (advancedFilters.maxYearBuilt) document.getElementById('advMaxYearBuilt').value = advancedFilters.maxYearBuilt;
            if (advancedFilters.propertyType) document.getElementById('advPropertyType').value = advancedFilters.propertyType;
            if (advancedFilters.neighborhood) document.getElementById('advNeighborhood').value = advancedFilters.neighborhood;
            if (advancedFilters.minLivingArea) document.getElementById('advMinLivingArea').value = advancedFilters.minLivingArea;
            if (advancedFilters.maxLivingArea) document.getElementById('advMaxLivingArea').value = advancedFilters.maxLivingArea;
            if (advancedFilters.notes) document.getElementById('advNotes').value = advancedFilters.notes;
        }

        // Close Advanced Search Modal
        function closeAdvancedSearch() {
            document.getElementById('advancedSearchModal').classList.remove('active');
        }

        // Clear Advanced Search
        function clearAdvancedSearch() {
            document.getElementById('advAddress').value = '';
            document.getElementById('advOwner').value = '';
            document.getElementById('advParcelId').value = '';
            document.getElementById('advMinValue').value = '';
            document.getElementById('advMaxValue').value = '';
            document.getElementById('advMinOwnership').value = '';
            document.getElementById('advMaxOwnership').value = '';
            document.getElementById('advMinYearBuilt').value = '';
            document.getElementById('advMaxYearBuilt').value = '';
            document.getElementById('advPropertyType').value = '';
            document.getElementById('advNeighborhood').value = '';
            document.getElementById('advMinLivingArea').value = '';
            document.getElementById('advMaxLivingArea').value = '';
            document.getElementById('advNotes').value = '';
        }

        // Apply Advanced Search
        function applyAdvancedSearch() {
            advancedFilters = {};
            
            const address = document.getElementById('advAddress').value.trim();
            const owner = document.getElementById('advOwner').value.trim();
            const parcelId = document.getElementById('advParcelId').value.trim();
            const minValue = document.getElementById('advMinValue').value;
            const maxValue = document.getElementById('advMaxValue').value;
            const minOwnership = document.getElementById('advMinOwnership').value;
            const maxOwnership = document.getElementById('advMaxOwnership').value;
            const minYearBuilt = document.getElementById('advMinYearBuilt').value;
            const maxYearBuilt = document.getElementById('advMaxYearBuilt').value;
            const propType = document.getElementById('advPropertyType').value;
            const neighborhood = document.getElementById('advNeighborhood').value.trim();
            const minLivingArea = document.getElementById('advMinLivingArea').value;
            const maxLivingArea = document.getElementById('advMaxLivingArea').value;
            const notes = document.getElementById('advNotes').value.trim();
            
            if (address) advancedFilters.address = address;
            if (owner) advancedFilters.owner = owner;
            if (parcelId) advancedFilters.parcelId = parcelId;
            if (minValue) advancedFilters.minValue = parseInt(minValue);
            if (maxValue) advancedFilters.maxValue = parseInt(maxValue);
            if (minOwnership) advancedFilters.minOwnership = parseInt(minOwnership);
            if (maxOwnership) advancedFilters.maxOwnership = parseInt(maxOwnership);
            if (minYearBuilt) advancedFilters.minYearBuilt = parseInt(minYearBuilt);
            if (maxYearBuilt) advancedFilters.maxYearBuilt = parseInt(maxYearBuilt);
            if (propType) {
                advancedFilters.propertyType = propType;
                propertyTypeFilter = propType;
                document.getElementById('propertyTypeFilter').value = propType;
            }
            if (neighborhood) advancedFilters.neighborhood = neighborhood;
            if (minLivingArea) advancedFilters.minLivingArea = parseInt(minLivingArea);
            if (maxLivingArea) advancedFilters.maxLivingArea = parseInt(maxLivingArea);
            if (notes) advancedFilters.notes = notes;
            
            closeAdvancedSearch();
            currentPage = 1;
            loadProperties();
            updateSearchResultsInfo();
            
            const filterCount = Object.keys(advancedFilters).length;
            showToast(`Applied ${filterCount} filter${filterCount !== 1 ? 's' : ''}`, 'success');
        }

        // Pagination
        function updatePagination(count) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const info = document.getElementById('paginationInfo');

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = count < pageSize;
            info.textContent = `Page ${currentPage}`;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadProperties();
            }
        }

        function nextPage() {
            currentPage++;
            loadProperties();
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Utility Functions
        function formatNumber(num) {
            if (!num) return '0';
            return Number(num).toLocaleString();
        }

        function formatStatus(status) {
            const labels = {
                'new': 'New',
                'contacted': 'Contacted',
                'interested': 'Interested',
                'hot': 'Hot',
                'follow_up': 'Follow-up',
                'not_interested': 'Not Interested',
                'closed': 'Closed'
            };
            return labels[status] || status;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on outside click
        document.getElementById('propertyModal').addEventListener('click', (e) => {
            if (e.target.id === 'propertyModal') closeModal();
        });

        // ============================================================
        // BUSINESS CERTIFICATES VIEW FUNCTIONS
        // ============================================================

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            document.getElementById('propertiesView').classList.toggle('active', view === 'properties');
            document.getElementById('certificatesView').classList.toggle('active', view === 'certificates');
            document.getElementById('permitsView').classList.toggle('active', view === 'permits');
            if (view === 'certificates') {
                loadCertificatesStats();
                populateYearDropdown();
                loadCertificates();
                setupCertSearch();
            }
            if (view === 'permits') {
                loadPermitsStats();
                populatePermitDropdowns();
                loadPermits();
                setupPermitSearch();
            }
        }

        function populateYearDropdown() {
            const yearSelect = document.getElementById('certExpYear');
            if (yearSelect.options.length > 1) return; // Already populated

            // Use a reasonable year range without querying database
            // Certificates typically expire 4 years after filing, so show current year through +5 years
            const currentYear = new Date().getFullYear();
            for (let year = currentYear + 5; year >= currentYear - 2; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function applyDateFilter() {
            certExpYear = document.getElementById('certExpYear').value;
            certExpMonth = document.getElementById('certExpMonth').value;
            certDateRangeStart = null;
            certDateRangeEnd = null;
            certQuickFilter = null;
            // Clear quick filter highlights
            document.querySelectorAll('.cert-quick-filter').forEach(btn => btn.classList.remove('active'));
            certCurrentPage = 1;
            loadCertificates();
        }

        function clearDateFilter() {
            document.getElementById('certExpYear').value = '';
            document.getElementById('certExpMonth').value = '';
            certExpYear = '';
            certExpMonth = '';
            certDateRangeStart = null;
            certDateRangeEnd = null;
            certQuickFilter = null;
            document.querySelectorAll('.cert-quick-filter').forEach(btn => btn.classList.remove('active'));
            certCurrentPage = 1;
            loadCertificates();
        }

        function setQuickDateFilter(filter) {
            // Clear year/month selects
            document.getElementById('certExpYear').value = '';
            document.getElementById('certExpMonth').value = '';
            certExpYear = '';
            certExpMonth = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (typeof filter === 'number') {
                // Days from now
                certDateRangeStart = today.toISOString().split('T')[0];
                const endDate = new Date(today);
                endDate.setDate(endDate.getDate() + filter);
                certDateRangeEnd = endDate.toISOString().split('T')[0];
            } else if (filter === 'thisYear') {
                certDateRangeStart = `${today.getFullYear()}-01-01`;
                certDateRangeEnd = `${today.getFullYear()}-12-31`;
            } else if (filter === 'nextYear') {
                const nextYear = today.getFullYear() + 1;
                certDateRangeStart = `${nextYear}-01-01`;
                certDateRangeEnd = `${nextYear}-12-31`;
            }

            certQuickFilter = filter;
            // Highlight active quick filter
            document.querySelectorAll('.cert-quick-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.quick == filter);
            });
            certCurrentPage = 1;
            loadCertificates();
        }

        function setupCertSearch() {
            const certSearchInput = document.getElementById('certSearchInput');
            const certSearchClear = document.getElementById('certSearchClear');
            if (!certSearchInput._initialized) {
                certSearchInput.addEventListener('input', (e) => {
                    clearTimeout(certSearchTimeout);
                    certSearchQuery = e.target.value.trim();
                    certSearchClear.style.display = certSearchQuery.length > 0 ? 'flex' : 'none';
                    certSearchTimeout = setTimeout(() => {
                        certCurrentPage = 1;
                        loadCertificates();
                    }, 300);
                });
                certSearchInput._initialized = true;
            }
        }

        function clearCertSearch() {
            document.getElementById('certSearchInput').value = '';
            certSearchQuery = '';
            document.getElementById('certSearchClear').style.display = 'none';
            certCurrentPage = 1;
            loadCertificates();
        }

        async function loadCertificatesStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                // Run all count queries in parallel for better performance
                const [totalResult, activeResult, linkedResult] = await Promise.all([
                    db.from('business_certificates').select('*', { count: 'exact', head: true }),
                    db.from('business_certificates').select('*', { count: 'exact', head: true }).or(`expiration_date.gte.${today},expiration_date.is.null`),
                    db.from('business_certificates').select('*', { count: 'exact', head: true }).not('linked_parcel_id', 'is', null)
                ]);
                const total = totalResult.count || 0;
                const active = activeResult.count || 0;
                document.getElementById('certStatTotal').textContent = formatNumber(total);
                document.getElementById('tabCertsCount').textContent = formatNumber(total);
                document.getElementById('certStatActive').textContent = formatNumber(active);
                document.getElementById('certStatExpired').textContent = formatNumber(total - active);
                document.getElementById('certStatLinked').textContent = formatNumber(linkedResult.count || 0);
            } catch (e) { console.error('Error loading cert stats:', e); }
        }

        async function loadCertificates() {
            const tbody = document.getElementById('certTableBody');
            tbody.textContent = '';
            const loadingRow = document.createElement('tr');
            const loadingCell = document.createElement('td');
            loadingCell.colSpan = 7;
            loadingCell.style.cssText = 'text-align: center; padding: 40px;';
            loadingCell.textContent = 'Loading certificates...';
            loadingRow.appendChild(loadingCell);
            tbody.appendChild(loadingRow);
            try {
                const from = (certCurrentPage - 1) * certPageSize;
                const to = from + certPageSize - 1;
                const today = new Date().toISOString().split('T')[0];
                let query = db.from('business_certificates').select('*', { count: 'exact' });

                // Text search filter
                if (certSearchQuery) query = query.or(`business_name.ilike.%${certSearchQuery}%,address.ilike.%${certSearchQuery}%,certificate_number.ilike.%${certSearchQuery}%`);

                // Status filter
                if (certFilter === 'active') query = query.or(`expiration_date.gte.${today},expiration_date.is.null`);
                else if (certFilter === 'expired') query = query.lt('expiration_date', today);
                else if (certFilter === 'linked') query = query.not('linked_parcel_id', 'is', null);

                // Date range filter (from quick filters)
                if (certDateRangeStart && certDateRangeEnd) {
                    query = query.gte('expiration_date', certDateRangeStart).lte('expiration_date', certDateRangeEnd);
                }
                // Year/Month filter (from dropdowns)
                else if (certExpYear || certExpMonth) {
                    if (certExpYear && certExpMonth) {
                        // Specific month in specific year (e.g., March 2027)
                        const startDate = `${certExpYear}-${certExpMonth}-01`;
                        const lastDay = new Date(certExpYear, parseInt(certExpMonth), 0).getDate();
                        const endDate = `${certExpYear}-${certExpMonth}-${lastDay}`;
                        query = query.gte('expiration_date', startDate).lte('expiration_date', endDate);
                    } else if (certExpYear) {
                        // Any month in specific year
                        query = query.gte('expiration_date', `${certExpYear}-01-01`).lte('expiration_date', `${certExpYear}-12-31`);
                    } else if (certExpMonth) {
                        // Specific month in any year - filter all matching months
                        query = query.not('expiration_date', 'is', null);
                        // Note: Supabase doesn't support EXTRACT, so we'll filter client-side for month-only
                    }
                }

                query = query.order(certSortColumn, { ascending: certSortDirection === 'asc', nullsFirst: false }).range(from, to);
                const { data, error, count } = await query;
                if (error) throw error;
                certTotalCount = count || 0;
                updateCertResultsInfo();
                updateCertPagination();
                tbody.textContent = '';
                if (!data || data.length === 0) {
                    const emptyRow = document.createElement('tr');
                    const emptyCell = document.createElement('td');
                    emptyCell.colSpan = 7;
                    emptyCell.style.cssText = 'text-align: center; padding: 40px; color: var(--gray-500);';
                    emptyCell.textContent = 'No certificates found';
                    emptyRow.appendChild(emptyCell);
                    tbody.appendChild(emptyRow);
                    return;
                }
                data.forEach(cert => {
                    const row = document.createElement('tr');
                    const isExpired = cert.expiration_date && cert.expiration_date < today;
                    const cells = [
                        { content: cert.certificate_number || 'N/A', bold: true },
                        { content: cert.business_name || 'N/A', className: 'cert-business-name' },
                        { content: cert.address || 'N/A', className: 'cert-address' },
                        { content: cert.file_date || 'N/A' },
                        { content: cert.expiration_date || 'N/A' },
                        { content: isExpired ? 'Expired' : 'Active', badge: true, isExpired },
                        { content: cert.linked_parcel_id, isLink: true }
                    ];
                    cells.forEach((cellData, i) => {
                        const td = document.createElement('td');
                        if (i === 5) {
                            const badge = document.createElement('span');
                            badge.className = `cert-status-badge ${cellData.isExpired ? 'expired' : 'active'}`;
                            badge.textContent = cellData.isExpired ? '❌ Expired' : '✅ Active';
                            td.appendChild(badge);
                        } else if (i === 6) {
                            if (cellData.content) {
                                const link = document.createElement('a');
                                link.className = 'linked-property-link';
                                link.textContent = '🔗 View Property';
                                link.onclick = () => viewLinkedProperty(cellData.content);
                                td.appendChild(link);
                            } else {
                                td.style.color = 'var(--gray-400)';
                                td.textContent = '-';
                            }
                        } else if (cellData.bold) {
                            const strong = document.createElement('strong');
                            strong.textContent = cellData.content;
                            td.appendChild(strong);
                        } else if (cellData.className) {
                            const div = document.createElement('div');
                            div.className = cellData.className;
                            div.textContent = cellData.content;
                            td.appendChild(div);
                        } else {
                            td.textContent = cellData.content;
                        }
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                });
            } catch (e) {
                console.error('Error loading certificates:', e);
                tbody.textContent = '';
                const errRow = document.createElement('tr');
                const errCell = document.createElement('td');
                errCell.colSpan = 7;
                errCell.style.cssText = 'text-align: center; padding: 40px; color: var(--danger);';
                errCell.textContent = 'Error loading certificates';
                errRow.appendChild(errCell);
                tbody.appendChild(errRow);
            }
        }

        function setCertFilter(filter) {
            certFilter = filter;
            certCurrentPage = 1;
            document.querySelectorAll('.cert-filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });
            loadCertificates();
        }

        function sortCerts(column) {
            if (certSortColumn === column) certSortDirection = certSortDirection === 'asc' ? 'desc' : 'asc';
            else { certSortColumn = column; certSortDirection = 'desc'; }
            loadCertificates();
        }

        function certPrevPage() { if (certCurrentPage > 1) { certCurrentPage--; loadCertificates(); } }
        function certNextPage() { const maxPage = Math.ceil(certTotalCount / certPageSize); if (certCurrentPage < maxPage) { certCurrentPage++; loadCertificates(); } }
        function updateCertPagination() {
            const maxPage = Math.ceil(certTotalCount / certPageSize) || 1;
            document.getElementById('certPageInfo').textContent = `Page ${certCurrentPage} of ${maxPage}`;
            document.getElementById('certPrevBtn').disabled = certCurrentPage <= 1;
            document.getElementById('certNextBtn').disabled = certCurrentPage >= maxPage;
        }
        function updateCertResultsInfo() {
            const from = (certCurrentPage - 1) * certPageSize + 1;
            const to = Math.min(certCurrentPage * certPageSize, certTotalCount);
            let info = certTotalCount > 0 ? `Showing ${from}-${to} of ${formatNumber(certTotalCount)} certificates` : 'No certificates found';

            // Add filter description
            let filterDesc = [];
            if (certExpYear && certExpMonth) {
                const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                filterDesc.push(`expiring ${monthNames[parseInt(certExpMonth)]} ${certExpYear}`);
            } else if (certExpYear) {
                filterDesc.push(`expiring in ${certExpYear}`);
            } else if (certDateRangeStart && certDateRangeEnd) {
                if (certQuickFilter === 'thisYear') filterDesc.push('expiring this year');
                else if (certQuickFilter === 'nextYear') filterDesc.push('expiring next year');
                else if (typeof certQuickFilter === 'number') filterDesc.push(`expiring in next ${certQuickFilter} days`);
            }
            if (filterDesc.length > 0) {
                info += ` (${filterDesc.join(', ')})`;
            }

            document.getElementById('certResultsInfo').textContent = info;
        }

        // ============================================================
        // BUILDING PERMITS VIEW FUNCTIONS
        // ============================================================

        async function loadPermitsStats() {
            try {
                // Run all count queries in parallel for better performance
                const [totalResult, issuedResult, pendingResult, linkedResult] = await Promise.all([
                    db.from('building_permits').select('*', { count: 'exact', head: true }),
                    db.from('building_permits').select('*', { count: 'exact', head: true }).ilike('record_status', '%issued%'),
                    db.from('building_permits').select('*', { count: 'exact', head: true }).or('record_status.ilike.%pending%,record_status.ilike.%review%,record_status.ilike.%submitted%'),
                    db.from('building_permits').select('*', { count: 'exact', head: true }).not('mbl', 'is', null)
                ]);

                document.getElementById('permitStatTotal').textContent = formatNumber(totalResult.count || 0);
                document.getElementById('permitStatIssued').textContent = formatNumber(issuedResult.count || 0);
                document.getElementById('permitStatPending').textContent = formatNumber(pendingResult.count || 0);
                document.getElementById('permitStatLinked').textContent = formatNumber(linkedResult.count || 0);
            } catch (e) {
                console.error('Error loading permit stats:', e);
            }
        }

        async function populatePermitDropdowns() {
            // Use predefined common values to avoid slow queries
            const commonStatuses = ['Active', 'Issued', 'Pending', 'Approved', 'Completed', 'Denied', 'Cancelled', 'Expired', 'Under Review'];
            const commonTypes = ['Alteration Renovations Repairs', 'Roofing', 'Insulation', 'Deck', 'Pool - Private Property', 'Ground or Wall Sign', 'Demolition', 'New Construction', 'Electrical', 'Plumbing', 'HVAC', 'Solar', 'Fence'];

            // Populate status dropdown with common values
            const statusSelect = document.getElementById('permitStatusFilter');
            if (statusSelect.options.length <= 1) {
                commonStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                });
            }

            // Populate type dropdown with common values
            const typeSelect = document.getElementById('permitTypeFilter');
            if (typeSelect.options.length <= 1) {
                commonTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
            }

            // Populate year dropdown with reasonable range (no query needed)
            const yearSelect = document.getElementById('permitDateYear');
            if (yearSelect.options.length <= 1) {
                const currentYear = new Date().getFullYear();
                for (let year = currentYear + 1; year >= 2015; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
            }
        }

        async function loadPermits() {
            const tbody = document.getElementById('permitTableBody');
            tbody.textContent = '';
            const loadingRow = document.createElement('tr');
            const loadingCell = document.createElement('td');
            loadingCell.colSpan = 11;
            loadingCell.style.cssText = 'text-align: center; padding: 40px;';
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            loadingCell.appendChild(spinner);
            loadingRow.appendChild(loadingCell);
            tbody.appendChild(loadingRow);

            try {
                let query = db.from('building_permits').select('*', { count: 'exact' });

                // Apply filters
                if (permitFilter === 'linked') {
                    query = query.not('linked_parcel_id', 'is', null);
                }

                if (permitStatusFilter) {
                    query = query.eq('record_status', permitStatusFilter);
                }

                if (permitTypeFilter) {
                    query = query.eq('permit_for', permitTypeFilter);
                }

                if (permitDateYear && permitDateMonth) {
                    const startDate = `${permitDateYear}-${permitDateMonth}-01`;
                    const lastDay = new Date(permitDateYear, parseInt(permitDateMonth), 0).getDate();
                    const endDate = `${permitDateYear}-${permitDateMonth}-${lastDay}`;
                    query = query.gte('date_submitted', startDate).lte('date_submitted', endDate);
                } else if (permitDateYear) {
                    query = query.gte('date_submitted', `${permitDateYear}-01-01`).lte('date_submitted', `${permitDateYear}-12-31`);
                }

                if (permitSearchQuery) {
                    query = query.or(`record_number.ilike.%${permitSearchQuery}%,address.ilike.%${permitSearchQuery}%,contractor_name.ilike.%${permitSearchQuery}%,permit_for.ilike.%${permitSearchQuery}%`);
                }

                // Apply sorting
                query = query.order(permitSortColumn, { ascending: permitSortDirection === 'asc' });

                // Apply pagination
                const from = (permitCurrentPage - 1) * permitPageSize;
                query = query.range(from, from + permitPageSize - 1);

                const { data, count, error } = await query;
                if (error) throw error;

                permitTotalCount = count || 0;
                renderPermitsTable(data || []);
                updatePermitPagination();
                updatePermitResultsInfo();

            } catch (e) {
                console.error('Error loading permits:', e);
                tbody.textContent = '';
                const errorRow = document.createElement('tr');
                const errorCell = document.createElement('td');
                errorCell.colSpan = 11;
                errorCell.style.cssText = 'text-align: center; padding: 40px; color: var(--danger);';
                errorCell.textContent = 'Error loading permits';
                errorRow.appendChild(errorCell);
                tbody.appendChild(errorRow);
            }
        }

        function renderPermitsTable(permits) {
            const tbody = document.getElementById('permitTableBody');
            tbody.textContent = '';

            if (permits.length === 0) {
                const emptyRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                emptyCell.colSpan = 11;
                emptyCell.style.cssText = 'text-align: center; padding: 40px; color: var(--gray-500);';
                emptyCell.textContent = 'No permits found';
                emptyRow.appendChild(emptyCell);
                tbody.appendChild(emptyRow);
                return;
            }

            permits.forEach(permit => {
                const row = document.createElement('tr');

                // Record number
                const cell1 = document.createElement('td');
                const strong = document.createElement('strong');
                strong.textContent = permit.record_number || '-';
                cell1.appendChild(strong);
                row.appendChild(cell1);

                // Record type
                const cellType = document.createElement('td');
                cellType.textContent = permit.record_type || '-';
                cellType.style.fontSize = '12px';
                row.appendChild(cellType);

                // Permit for
                const cell2 = document.createElement('td');
                cell2.textContent = permit.permit_for || '-';
                row.appendChild(cell2);

                // Address
                const cell3 = document.createElement('td');
                cell3.textContent = permit.address || '-';
                row.appendChild(cell3);

                // MBL
                const cellMbl = document.createElement('td');
                cellMbl.textContent = permit.mbl || '-';
                cellMbl.style.fontSize = '12px';
                cellMbl.style.fontFamily = 'monospace';
                row.appendChild(cellMbl);

                // Occupancy type
                const cellOccupancy = document.createElement('td');
                const occBadge = document.createElement('span');
                occBadge.className = 'table-badge ' + (permit.occupancy_type?.toLowerCase().includes('commercial') ? 'commercial' :
                                                       permit.occupancy_type?.toLowerCase().includes('residential') ? 'residential' : '');
                occBadge.textContent = permit.occupancy_type || '-';
                cellOccupancy.appendChild(occBadge);
                row.appendChild(cellOccupancy);

                // Status
                const cell4 = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = 'cert-status-badge ' + getPermitStatusClass(permit.record_status);
                statusBadge.textContent = permit.record_status || '-';
                cell4.appendChild(statusBadge);
                row.appendChild(cell4);

                // Submitted date
                const cell5 = document.createElement('td');
                cell5.textContent = permit.date_submitted ? new Date(permit.date_submitted).toLocaleDateString() : '-';
                row.appendChild(cell5);

                // Issued date
                const cell6 = document.createElement('td');
                cell6.textContent = permit.permit_issued_date ? new Date(permit.permit_issued_date).toLocaleDateString() : '-';
                row.appendChild(cell6);

                // Contractor
                const cellContractor = document.createElement('td');
                cellContractor.textContent = permit.contractor_name || '-';
                cellContractor.style.fontSize = '12px';
                row.appendChild(cellContractor);

                // Property link
                const cell7 = document.createElement('td');
                if (permit.mbl) {
                    const btn = document.createElement('button');
                    btn.className = 'cert-link-btn';
                    btn.textContent = 'View';
                    btn.onclick = () => viewLinkedProperty(permit.mbl);
                    cell7.appendChild(btn);
                } else {
                    const dash = document.createElement('span');
                    dash.style.color = 'var(--gray-400)';
                    dash.textContent = '—';
                    cell7.appendChild(dash);
                }
                row.appendChild(cell7);

                tbody.appendChild(row);
            });
        }

        function getPermitStatusClass(status) {
            if (!status) return '';
            const s = status.toLowerCase();
            if (s.includes('issued') || s.includes('approved') || s.includes('complete')) return 'status-active';
            if (s.includes('pending') || s.includes('review') || s.includes('submitted')) return 'status-pending';
            if (s.includes('denied') || s.includes('rejected') || s.includes('cancel')) return 'status-expired';
            return '';
        }

        function setPermitFilter(filter) {
            permitFilter = filter;
            permitCurrentPage = 1;
            document.querySelectorAll('#permitsView .cert-filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });
            loadPermits();
        }

        function applyPermitFilters() {
            permitStatusFilter = document.getElementById('permitStatusFilter').value;
            permitTypeFilter = document.getElementById('permitTypeFilter').value;
            permitDateYear = document.getElementById('permitDateYear').value;
            permitDateMonth = document.getElementById('permitDateMonth').value;
            permitCurrentPage = 1;
            loadPermits();
        }

        function clearPermitDateFilter() {
            document.getElementById('permitDateYear').value = '';
            document.getElementById('permitDateMonth').value = '';
            permitDateYear = '';
            permitDateMonth = '';
            permitCurrentPage = 1;
            loadPermits();
        }

        function sortPermits(column) {
            if (permitSortColumn === column) {
                permitSortDirection = permitSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                permitSortColumn = column;
                permitSortDirection = 'desc';
            }
            loadPermits();
        }

        function permitPrevPage() {
            if (permitCurrentPage > 1) {
                permitCurrentPage--;
                loadPermits();
            }
        }

        function permitNextPage() {
            const maxPage = Math.ceil(permitTotalCount / permitPageSize);
            if (permitCurrentPage < maxPage) {
                permitCurrentPage++;
                loadPermits();
            }
        }

        function updatePermitPagination() {
            const maxPage = Math.ceil(permitTotalCount / permitPageSize) || 1;
            document.getElementById('permitPageInfo').textContent = `Page ${permitCurrentPage} of ${maxPage}`;
            document.getElementById('permitPrevBtn').disabled = permitCurrentPage <= 1;
            document.getElementById('permitNextBtn').disabled = permitCurrentPage >= maxPage;
        }

        function setupPermitSearch() {
            const input = document.getElementById('permitSearchInput');
            const clearBtn = document.getElementById('permitSearchClear');

            input.addEventListener('input', (e) => {
                clearBtn.style.display = e.target.value ? 'block' : 'none';
                clearTimeout(permitSearchTimeout);
                permitSearchTimeout = setTimeout(() => {
                    permitSearchQuery = e.target.value.trim();
                    permitCurrentPage = 1;
                    loadPermits();
                }, 300);
            });
        }

        function clearPermitSearch() {
            document.getElementById('permitSearchInput').value = '';
            document.getElementById('permitSearchClear').style.display = 'none';
            permitSearchQuery = '';
            permitCurrentPage = 1;
            loadPermits();
        }

        function updatePermitResultsInfo() {
            const start = (permitCurrentPage - 1) * permitPageSize + 1;
            const end = Math.min(permitCurrentPage * permitPageSize, permitTotalCount);
            let info = `Showing ${start}-${end} of ${formatNumber(permitTotalCount)} permits`;

            const filterDesc = [];
            if (permitFilter === 'linked') filterDesc.push('linked only');
            if (permitStatusFilter) filterDesc.push(`status: ${permitStatusFilter}`);
            if (permitTypeFilter) filterDesc.push(`type: ${permitTypeFilter}`);
            if (permitDateYear) filterDesc.push(`year: ${permitDateYear}`);
            if (permitSearchQuery) filterDesc.push(`search: "${permitSearchQuery}"`);

            if (filterDesc.length > 0) {
                info += ` (${filterDesc.join(', ')})`;
            }

            document.getElementById('permitResultsInfo').textContent = info;
        }

        function viewLinkedProperty(parcelId) {
            previousView = currentView; // Save current view to return to after modal closes
            switchView('properties');
            setTimeout(() => openPropertyModal(parcelId), 100);
        }
        async function updateTabCounts() {
            const propCount = document.getElementById('statTotalProperties').textContent;
            document.getElementById('tabPropertiesCount').textContent = propCount;
            const { count } = await db.from('business_certificates').select('*', { count: 'exact', head: true });
            document.getElementById('tabCertsCount').textContent = formatNumber(count || 0);
            const { count: permitCount } = await db.from('building_permits').select('*', { count: 'exact', head: true });
            document.getElementById('tabPermitsCount').textContent = formatNumber(permitCount || 0);
        }

        // Lightbox functionality
        function openLightbox(startIndex = 0) {
            console.log('openLightbox called with index:', startIndex);
            console.log('currentPropertyImages:', currentPropertyImages);
            if (currentPropertyImages.length === 0) {
                console.warn('No images available for lightbox');
                return;
            }
            const overlay = document.getElementById('lightboxOverlay');
            if (!overlay) {
                console.error('Lightbox overlay element not found!');
                return;
            }
            lightboxImages = currentPropertyImages;
            lightboxCurrentIndex = startIndex;
            updateLightboxImage();
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Lightbox opened successfully');
        }

        function closeLightbox(event) {
            if (event) event.stopPropagation();
            document.getElementById('lightboxOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigateLightbox(event, direction) {
            event.stopPropagation();
            lightboxCurrentIndex += direction;
            if (lightboxCurrentIndex < 0) lightboxCurrentIndex = lightboxImages.length - 1;
            if (lightboxCurrentIndex >= lightboxImages.length) lightboxCurrentIndex = 0;
            updateLightboxImage();
        }

        function updateLightboxImage() {
            const img = lightboxImages[lightboxCurrentIndex];
            if (!img) return;
            document.getElementById('lightboxImage').src = img.url;
            document.getElementById('lightboxCaption').textContent = img.caption || '';
            document.getElementById('lightboxCounter').textContent = `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;

            // Show/hide navigation if only one image
            const navButtons = document.querySelectorAll('.lightbox-nav');
            navButtons.forEach(btn => btn.style.display = lightboxImages.length > 1 ? 'flex' : 'none');
            document.getElementById('lightboxCounter').style.display = lightboxImages.length > 1 ? 'block' : 'none';
        }

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('lightboxOverlay');
            if (!overlay || !overlay.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeLeadPanel();
                }
                return;
            }

            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') navigateLightbox(e, -1);
            if (e.key === 'ArrowRight') navigateLightbox(e, 1);
        });
    </script>
</body>
</html>

