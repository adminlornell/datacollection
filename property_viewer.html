<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worcester Property Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .search-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .property-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .property-address {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .property-owner {
            color: #666;
            margin-bottom: 8px;
        }

        .property-details {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #555;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
        }

        .property-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
            position: relative;
        }

        .modal-header {
            padding: 30px;
            border-bottom: 2px solid #f0f0f0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .photo-item {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .photo-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .photo-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
        }

        .photo-item:hover img {
            transform: scale(1.05);
        }

        .photo-item .photo-label {
            padding: 12px;
            background: #f8f9fa;
            font-size: 13px;
            color: #666;
            font-weight: 500;
            text-align: center;
        }

        /* Photo Lightbox */
        .photo-lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .photo-lightbox.active {
            display: flex;
        }

        .photo-lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .photo-lightbox-image-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 100%;
            max-height: 80vh;
        }

        .photo-lightbox img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .photo-lightbox-info {
            color: white;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }

        .photo-lightbox-close {
            position: absolute;
            top: -60px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 28px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .photo-lightbox-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .photo-lightbox-nav {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .photo-lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .photo-lightbox-nav.prev {
            margin-right: 20px;
        }

        .photo-lightbox-nav.next {
            margin-left: 20px;
        }

        .photo-lightbox-counter {
            position: absolute;
            top: -60px;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .photo-lightbox-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .json-view {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Worcester Property Viewer</h1>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search by address, owner, or parcel ID (min 2 chars)...">
                <button class="btn btn-primary" onclick="searchProperties(1)">Search</button>
                <button class="btn btn-secondary" onclick="document.getElementById('searchInput').value=''; totalCount=0; loadProperties(1)">Show All</button>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Properties</div>
                    <div class="stat-value" id="totalProperties">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Showing</div>
                    <div class="stat-value" id="showingCount">-</div>
                </div>
            </div>
        </div>

        <div id="propertiesContainer" class="properties-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading properties...</p>
            </div>
        </div>

        <div id="pagination" class="pagination"></div>
    </div>

    <!-- Property Detail Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <h2 id="modalTitle">Property Details</h2>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading property details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Lightbox -->
    <div id="photoLightbox" class="photo-lightbox" onclick="closePhotoLightbox(event)">
        <div class="photo-lightbox-content" onclick="event.stopPropagation()">
            <div class="photo-lightbox-header">
                <div class="photo-lightbox-counter" id="photoCounter"></div>
                <button class="photo-lightbox-close" onclick="closePhotoLightbox()">&times;</button>
            </div>
            <div class="photo-lightbox-image-container">
                <button class="photo-lightbox-nav prev" onclick="navigatePhoto(-1)">‚Äπ</button>
                <img id="lightboxImage" src="" alt="">
                <button class="photo-lightbox-nav next" onclick="navigatePhoto(1)">‚Ä∫</button>
            </div>
            <div class="photo-lightbox-info" id="photoInfo"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://cxcgeumhfjvnuibxnbob.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4Y2dldW1oZmp2bnVpYnhuYm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxOTc5MTYsImV4cCI6MjA3NDc3MzkxNn0.5p6YdLSEF54r-LVOPFhD4OpehMXx6K1q8RPWm3XKeS8';
        
        // Create Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentPage = 1;
        const itemsPerPage = 20;
        let totalCount = 0;
        let searchTimeout = null;
        let currentSearchAbort = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProperties();
            
            // Debounced search on input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length === 0) {
                    loadProperties();
                    return;
                }
                
                // Wait 500ms after user stops typing
                searchTimeout = setTimeout(() => {
                    searchProperties(1);
                }, 500);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchProperties(1);
                }
            });
        });

        async function loadProperties(page = 1) {
            currentPage = page;
            const container = document.getElementById('propertiesContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading properties...</p></div>';

            try {
                const from = (page - 1) * itemsPerPage;
                const to = from + itemsPerPage - 1;

                // Don't get count on initial load - it's too slow with 46k+ records
                // Just load the data and estimate if we have more pages
                const { data, error } = await supabaseClient
                    .from('worcester_data_collection')
                    .select('parcel_id, location, owner_name, total_assessed_value, year_built, living_area_sqft, bedrooms, bathrooms, building_style, street_name')
                    .order('total_assessed_value', { ascending: false, nullsLast: true })
                    .range(from, to);

                if (error) throw error;

                // Estimate count: if we got a full page, assume there are more
                const hasMore = data && data.length === itemsPerPage;
                if (page === 1 && !totalCount) {
                    // On first load, set a large estimated count to show pagination
                    totalCount = hasMore ? 50000 : data.length;
                } else if (!hasMore) {
                    // If we got less than a full page, we're at the end
                    totalCount = (page - 1) * itemsPerPage + (data?.length || 0);
                }

                updateStats();
                displayProperties(data || []);
                updatePagination(false); // Use estimated pagination
            } catch (error) {
                console.error('Error loading properties:', error);
                const isTimeout = error.message && (error.message.includes('timeout') || error.message.includes('canceling'));
                const errorMsg = isTimeout
                    ? 'Query timed out. Try using the search feature with specific terms, or browse by parcel ID.'
                    : error.message || JSON.stringify(error);
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p><strong>Error loading properties:</strong></p>
                        <p style="margin-top: 10px; font-size: 14px; color: #666;">${escapeHtml(errorMsg)}</p>
                        ${isTimeout ? `
                            <div style="margin-top: 20px;">
                                <p style="font-size: 12px; color: #999; margin-bottom: 15px;">Try one of these options:</p>
                                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="loadProperties(1)">Try Again</button>
                                    <button class="btn btn-secondary" onclick="document.getElementById('searchInput').focus()">Search Properties</button>
                                </div>
                                <p style="font-size: 12px; color: #999; margin-top: 15px;">Tip: Search by parcel ID (e.g., "1491") for fastest results</p>
                            </div>
                        ` : '<p style="margin-top: 20px; font-size: 12px; color: #999;">Check the browser console (F12) for more details.</p>'}
                    </div>
                `;
            }
        }

        async function searchProperties(page = 1) {
            currentPage = page;
            const query = document.getElementById('searchInput').value.trim();
            const container = document.getElementById('propertiesContainer');
            
            // Show loading state
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            // Cancel previous search if still running
            if (currentSearchAbort) {
                currentSearchAbort.abort();
            }

            try {
                const from = (page - 1) * itemsPerPage;
                const to = from + itemsPerPage - 1;

                let queryBuilder;
                let countQuery;

                if (!query || query.length < 2) {
                    // If query is too short, just load all properties
                    loadProperties(page);
                    return;
                }

                // Optimize search: try parcel_id first (exact match is fastest)
                if (/^\d+$/.test(query)) {
                    // Numeric query - search parcel_id first
                    queryBuilder = supabaseClient
                        .from('worcester_data_collection')
                        .select('parcel_id, location, owner_name, total_assessed_value, year_built, living_area_sqft, bedrooms, bathrooms, building_style, street_name')
                        .ilike('parcel_id', `%${query}%`)
                        .order('total_assessed_value', { ascending: false, nullsLast: true })
                        .range(from, to);
                    
                    // Get count separately with timeout handling
                    countQuery = supabaseClient
                        .from('worcester_data_collection')
                        .select('parcel_id', { count: 'exact', head: true })
                        .ilike('parcel_id', `%${query}%`);
                } else {
                    // Text query - search location and owner_name
                    // Use ilike with proper escaping
                    const searchPattern = `%${query}%`;
                    
                    queryBuilder = supabaseClient
                        .from('worcester_data_collection')
                        .select('parcel_id, location, owner_name, total_assessed_value, year_built, living_area_sqft, bedrooms, bathrooms, building_style, street_name')
                        .or(`location.ilike.%${query}%,owner_name.ilike.%${query}%`)
                        .order('total_assessed_value', { ascending: false, nullsLast: true })
                        .range(from, to);
                    
                    // Get count separately (skip count for performance on large text searches)
                    countQuery = Promise.resolve({ count: null }); // Skip count for text searches to avoid timeout
                }

                // Execute query with timeout
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Search timeout: Query took too long. Try a more specific search or search by parcel ID.')), 25000);
                });

                // Execute data query with timeout
                const dataResult = await Promise.race([
                    queryBuilder,
                    timeoutPromise
                ]);

                // Get count separately (don't block on it)
                let count = null;
                if (countQuery && typeof countQuery.then === 'function') {
                    try {
                        const countResult = await Promise.race([
                            countQuery,
                            new Promise(resolve => setTimeout(() => resolve({ count: null }), 5000)) // 5s timeout for count
                        ]);
                        count = countResult?.count || null;
                    } catch (e) {
                        console.warn('Count query failed:', e);
                        // Continue without count
                    }
                } else {
                    count = countQuery?.count || null;
                }

                const { data, error } = dataResult;

                if (error) throw error;

                // If count is null (timeout), estimate from data length
                // If we got a full page, there might be more results
                const hasMoreResults = data && data.length === itemsPerPage;
                totalCount = count !== null ? count : (hasMoreResults ? (page * itemsPerPage) + 1 : (page - 1) * itemsPerPage + (data?.length || 0));
                
                updateStats();
                displayProperties(data || []);
                
                // Show pagination even without exact count
                updatePagination(count !== null);
            } catch (error) {
                console.error('Error searching properties:', error);
                const isTimeout = error.message && error.message.includes('timeout');
                const errorMsg = isTimeout 
                    ? 'Search timed out. Try a more specific search term or search by parcel ID.'
                    : error.message || 'Unknown error occurred';
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p><strong>Error searching:</strong></p>
                        <p style="margin-top: 10px; font-size: 14px; color: #666;">${escapeHtml(errorMsg)}</p>
                        ${isTimeout ? `
                            <div style="margin-top: 20px;">
                                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">Tips for better search:</p>
                                <ul style="text-align: left; font-size: 12px; color: #666; max-width: 400px; margin: 0 auto;">
                                    <li>Use at least 3 characters</li>
                                    <li>Search by parcel ID (numbers only) for fastest results</li>
                                    <li>Search by street name or owner name</li>
                                    <li>Use "Show All" to browse all properties</li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            } finally {
                currentSearchAbort = null;
            }
        }

        function displayProperties(properties) {
            const container = document.getElementById('propertiesContainer');
            
            if (properties.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No properties found</p></div>';
                return;
            }

            container.innerHTML = properties.map(prop => `
                <div class="property-card" onclick="showPropertyDetail('${prop.parcel_id}')">
                    <div class="property-address">${escapeHtml(prop.location || 'N/A')}</div>
                    <div class="property-owner">${escapeHtml(prop.owner_name || 'N/A')}</div>
                    ${prop.total_assessed_value ? `<div class="property-value">$${formatNumber(prop.total_assessed_value)}</div>` : ''}
                    <div class="property-details">
                        ${prop.year_built ? `<div class="detail-item"><span class="detail-label">Built:</span> ${prop.year_built}</div>` : ''}
                        ${prop.living_area_sqft ? `<div class="detail-item"><span class="detail-label">Sqft:</span> ${formatNumber(prop.living_area_sqft)}</div>` : ''}
                        ${prop.bedrooms ? `<div class="detail-item"><span class="detail-label">Beds:</span> ${prop.bedrooms}</div>` : ''}
                        ${prop.bathrooms ? `<div class="detail-item"><span class="detail-label">Baths:</span> ${prop.bathrooms}</div>` : ''}
                        ${prop.building_style ? `<div class="detail-item"><span class="detail-label">Style:</span> ${escapeHtml(prop.building_style)}</div>` : ''}
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #999;">Parcel ID: ${prop.parcel_id}</div>
                </div>
            `).join('');
        }

        async function showPropertyDetail(parcelId) {
            const modal = document.getElementById('propertyModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading property details...</p></div>';

            try {
                const { data, error } = await supabaseClient
                    .from('worcester_data_collection')
                    .select('*')
                    .eq('parcel_id', parcelId)
                    .single();

                if (error) throw error;

                modalTitle.textContent = data.location || `Parcel ${parcelId}`;
                modalBody.innerHTML = renderPropertyDetail(data);
            } catch (error) {
                console.error('Error loading property detail:', error);
                modalBody.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error loading property: ${error.message}</p></div>`;
            }
        }

        // Store current property photos globally for lightbox
        let currentPropertyPhotos = [];

        function renderPropertyDetail(prop) {
            const photos = prop.photos || [];
            currentPropertyPhotos = photos; // Store for lightbox access
            const buildings = prop.buildings || [];
            const salesHistory = prop.sales_history || [];
            const layouts = prop.layouts || [];

            return `
                <!-- Basic Information -->
                <div class="section">
                    <div class="section-title">Basic Information</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Parcel ID</div>
                            <div class="info-value">${prop.parcel_id || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value">${escapeHtml(prop.location || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Street</div>
                            <div class="info-value">${escapeHtml(prop.street_name || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Neighborhood</div>
                            <div class="info-value">${escapeHtml(prop.neighborhood || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Zoning</div>
                            <div class="info-value">${escapeHtml(prop.zoning || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Use Code</div>
                            <div class="info-value">${escapeHtml(prop.use_code || 'N/A')}</div>
                        </div>
                    </div>
                </div>

                <!-- Owner Information -->
                <div class="section">
                    <div class="section-title">Owner Information</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Owner Name</div>
                            <div class="info-value">${escapeHtml(prop.owner_name || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Co-Owner</div>
                            <div class="info-value">${escapeHtml(prop.co_owner || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Mailing Address</div>
                            <div class="info-value">${escapeHtml(prop.owner_mailing_address || 'N/A')}</div>
                        </div>
                    </div>
                </div>

                <!-- Assessment Values -->
                <div class="section">
                    <div class="section-title">Assessment Values</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Total Assessed Value</div>
                            <div class="info-value">${prop.total_assessed_value ? '$' + formatNumber(prop.total_assessed_value) : 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Land Value</div>
                            <div class="info-value">${prop.land_value ? '$' + formatNumber(prop.land_value) : 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Improvements Value</div>
                            <div class="info-value">${prop.improvements_value ? '$' + formatNumber(prop.improvements_value) : 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <!-- Property Details -->
                <div class="section">
                    <div class="section-title">Property Details</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Year Built</div>
                            <div class="info-value">${prop.year_built || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Living Area (sqft)</div>
                            <div class="info-value">${prop.living_area_sqft ? formatNumber(prop.living_area_sqft) : 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Lot Size (sqft)</div>
                            <div class="info-value">${prop.lot_size_sqft ? formatNumber(prop.lot_size_sqft) : 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Lot Size (acres)</div>
                            <div class="info-value">${prop.lot_size_acres ? prop.lot_size_acres.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Bedrooms</div>
                            <div class="info-value">${prop.bedrooms || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Bathrooms</div>
                            <div class="info-value">${prop.bathrooms || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Rooms</div>
                            <div class="info-value">${prop.total_rooms || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Building Style</div>
                            <div class="info-value">${escapeHtml(prop.building_style || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Exterior Wall</div>
                            <div class="info-value">${escapeHtml(prop.exterior_wall || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Roof Structure</div>
                            <div class="info-value">${escapeHtml(prop.roof_structure || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Heat Type</div>
                            <div class="info-value">${escapeHtml(prop.heat_type || 'N/A')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">AC Type</div>
                            <div class="info-value">${escapeHtml(prop.ac_type || 'N/A')}</div>
                        </div>
                    </div>
                </div>

                <!-- Photos -->
                ${photos.length > 0 ? `
                <div class="section">
                    <div class="section-title">Photos (${photos.length})</div>
                    <div class="photos-grid">
                        ${photos.map((photo, photoIdx) => `
                            <div class="photo-item" onclick="openPhotoLightbox(${photoIdx})">
                                <img src="${photo.url}" alt="${escapeHtml(photo.description || 'Property photo')}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage not available%3C/text%3E%3C/svg%3E'">
                                <div class="photo-label">${escapeHtml(photo.description || photo.photo_type || 'Photo')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Sales History -->
                ${salesHistory.length > 0 ? `
                <div class="section">
                    <div class="section-title">Sales History</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sale Date</th>
                                <th>Owner</th>
                                <th>Sale Price</th>
                                <th>Book & Page</th>
                                <th>Instrument</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesHistory.map(sale => `
                                <tr>
                                    <td>${escapeHtml(sale['Sale Date'] || sale.sale_date || 'N/A')}</td>
                                    <td>${escapeHtml(sale.Owner || sale.owner || 'N/A')}</td>
                                    <td>${escapeHtml(sale['Sale Price'] || sale.sale_price || 'N/A')}</td>
                                    <td>${escapeHtml(sale['Book & Page'] || sale.book_page || 'N/A')}</td>
                                    <td>${escapeHtml(sale.Instrument || sale.instrument || 'N/A')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                <!-- Buildings -->
                ${buildings.length > 0 ? `
                <div class="section">
                    <div class="section-title">Buildings (${buildings.length})</div>
                    ${buildings.map((bldg, idx) => `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h3 style="margin-bottom: 10px;">Building ${bldg.building_number || idx + 1}</h3>
                            <div class="info-grid">
                                ${bldg.year_built ? `<div class="info-item"><div class="info-label">Year Built</div><div class="info-value">${bldg.year_built}</div></div>` : ''}
                                ${bldg.living_area_sqft ? `<div class="info-item"><div class="info-label">Living Area</div><div class="info-value">${bldg.living_area_sqft}</div></div>` : ''}
                                ${bldg.total_gross_area ? `<div class="info-item"><div class="info-label">Total Gross Area</div><div class="info-value">${bldg.total_gross_area} sqft</div></div>` : ''}
                                ${bldg.replacement_cost ? `<div class="info-item"><div class="info-label">Replacement Cost</div><div class="info-value">${bldg.replacement_cost}</div></div>` : ''}
                                ${bldg.percent_good ? `<div class="info-item"><div class="info-label">Percent Good</div><div class="info-value">${bldg.percent_good}%</div></div>` : ''}
                            </div>
                            ${bldg.attributes ? `
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                    <strong style="display: block; margin-bottom: 15px; font-size: 16px; color: #333;">Building Attributes:</strong>
                                    <div class="info-grid">
                                        ${Object.entries(bldg.attributes).map(([key, value]) => {
                                            if (!value || value === '' || value === 'null') return '';
                                            // Format key name (convert snake_case to Title Case)
                                            const label = key
                                                .replace(/_/g, ' ')
                                                .replace(/\b\w/g, l => l.toUpperCase());
                                            return `
                                                <div class="info-item">
                                                    <div class="info-label">${escapeHtml(label)}</div>
                                                    <div class="info-value">${escapeHtml(String(value))}</div>
                                                </div>
                                            `;
                                        }).filter(Boolean).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <!-- Additional Data -->
                <div class="section">
                    <div class="section-title">Additional Information</div>
                    <div class="info-grid">
                        ${prop.last_sale_date ? `
                        <div class="info-item">
                            <div class="info-label">Last Sale Date</div>
                            <div class="info-value">${prop.last_sale_date}</div>
                        </div>
                        ` : ''}
                        ${prop.last_sale_price ? `
                        <div class="info-item">
                            <div class="info-label">Last Sale Price</div>
                            <div class="info-value">${prop.last_sale_price}</div>
                        </div>
                        ` : ''}
                        ${prop.tax_amount ? `
                        <div class="info-item">
                            <div class="info-label">Tax Amount</div>
                            <div class="info-value">$${formatNumber(prop.tax_amount)}</div>
                        </div>
                        ` : ''}
                        ${prop.tax_year ? `
                        <div class="info-item">
                            <div class="info-label">Tax Year</div>
                            <div class="info-value">${prop.tax_year}</div>
                        </div>
                        ` : ''}
                        ${prop.source_url ? `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-label">Source URL</div>
                            <div class="info-value"><a href="${prop.source_url}" target="_blank">${prop.source_url}</a></div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Raw JSON Data (Collapsible) -->
                <div class="section">
                    <div class="section-title">Raw Data (JSON)</div>
                    <details>
                        <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">Click to view raw JSON data</summary>
                        <div class="json-view">${JSON.stringify(prop, null, 2)}</div>
                    </details>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        function updateStats() {
            const totalEl = document.getElementById('totalProperties');
            const showingEl = document.getElementById('showingCount');
            
            if (totalCount > 0) {
                // Show estimated count with ~ if it's an estimate
                const isEstimate = totalCount >= 50000;
                totalEl.textContent = isEstimate ? `~${formatNumber(totalCount)}` : formatNumber(totalCount);
                const showing = Math.min(currentPage * itemsPerPage, totalCount);
                const start = (currentPage - 1) * itemsPerPage + 1;
                showingEl.textContent = `${start}-${showing}`;
            } else {
                totalEl.textContent = '-';
                showingEl.textContent = '-';
            }
        }

        function updatePagination(hasExactCount = true) {
            const pagination = document.getElementById('pagination');
            
            // If we don't have exact count, show simple prev/next navigation
            if (!hasExactCount) {
                const hasMoreResults = totalCount > currentPage * itemsPerPage;
                let html = '';
                
                if (currentPage > 1 || hasMoreResults) {
                    html += `<button onclick="loadPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
                    html += `<span style="padding: 0 15px; color: #666;">Page ${currentPage}</span>`;
                    html += `<button onclick="loadPage(${currentPage + 1})" ${!hasMoreResults ? 'disabled' : ''}>Next</button>`;
                    html += `<span style="padding-left: 15px; font-size: 12px; color: #999;">Showing results (estimated count)</span>`;
                } else {
                    pagination.innerHTML = '';
                }
                
                pagination.innerHTML = html;
                return;
            }
            
            // Full pagination with exact count
            const totalPages = Math.ceil(totalCount / itemsPerPage);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            html += `<button onclick="loadPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (startPage > 1) {
                html += `<button onclick="loadPage(1)">1</button>`;
                if (startPage > 2) html += `<span>...</span>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="loadPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span>...</span>`;
                html += `<button onclick="loadPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button onclick="loadPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            
            pagination.innerHTML = html;
        }

        function loadPage(page) {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                searchProperties(page);
            } else {
                loadProperties(page);
            }
        }

        function formatNumber(num) {
            if (!num) return '0';
            return Number(num).toLocaleString();
        }

        function escapeHtml(text) {
            if (!text) return 'N/A';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on outside click
        document.getElementById('propertyModal').addEventListener('click', (e) => {
            if (e.target.id === 'propertyModal') {
                closeModal();
            }
        });

        // Photo Lightbox functionality
        let currentPhotoIndex = 0;

        function openPhotoLightbox(index) {
            if (!currentPropertyPhotos || currentPropertyPhotos.length === 0) return;
            currentPhotoIndex = index;
            updateLightboxPhoto();
            document.getElementById('photoLightbox').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closePhotoLightbox(event) {
            if (!event || event.target.id === 'photoLightbox' || event.target.classList.contains('photo-lightbox-close')) {
                document.getElementById('photoLightbox').classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        function navigatePhoto(direction) {
            if (!currentPropertyPhotos || currentPropertyPhotos.length === 0) return;
            currentPhotoIndex += direction;
            if (currentPhotoIndex < 0) {
                currentPhotoIndex = currentPropertyPhotos.length - 1;
            } else if (currentPhotoIndex >= currentPropertyPhotos.length) {
                currentPhotoIndex = 0;
            }
            updateLightboxPhoto();
        }

        function updateLightboxPhoto() {
            if (!currentPropertyPhotos || currentPropertyPhotos.length === 0) return;
            
            const photo = currentPropertyPhotos[currentPhotoIndex];
            const img = document.getElementById('lightboxImage');
            const info = document.getElementById('photoInfo');
            const counter = document.getElementById('photoCounter');
            
            img.src = photo.url;
            img.alt = photo.description || 'Property photo';
            info.textContent = photo.description || photo.photo_type || 'Photo';
            counter.textContent = `${currentPhotoIndex + 1} / ${currentPropertyPhotos.length}`;
        }

        // Keyboard navigation for photo lightbox
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('photoLightbox');
            if (lightbox.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closePhotoLightbox();
                } else if (e.key === 'ArrowLeft') {
                    navigatePhoto(-1);
                } else if (e.key === 'ArrowRight') {
                    navigatePhoto(1);
                }
            }
        });
    </script>
</body>
</html>
